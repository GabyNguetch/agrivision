================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\app\map\[id]\page.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import dynamic from 'next/dynamic';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';
import {
  ArrowLeft, Leaf, MapPin, Package, Wheat, TrendingUp,
  Users, BarChart2, Layers, AlertCircle, ExternalLink,
  Building2, Factory, Store, TrendingDown, Calendar,
} from 'lucide-react';
import ThemeToggle from '@/components/ThemeToggle';
import type { MapLevel } from '@/types/api';
import {
  getRegion, getDepartement, getCommune,
  getRegionProductions, getDepartementProductions, getCommuneProductions,
  getRegionDepartements, getDepartementCommunes, getCommuneInfrastructures,
  getRegionsGeoJSON, getDepartementsGeoJSON, getCommunesGeoJSON,
  getFilieres, getCategories, getProduits,
} from '@/lib/api';

const DetailMap = dynamic(() => import('@/components/DetailMap'), {
  ssr: false,
  loading: () => (
    <div className="w-full h-full bg-gray-100 dark:bg-gray-900 flex items-center justify-center rounded-xl">
      <div className="inline-block w-10 h-10 border-3 border-green-500 border-t-transparent rounded-full animate-spin" />
    </div>
  ),
});

// FIX: Next.js 15 - params est maintenant une Promise
export default function DetailPage({ params }: { params: Promise<{ id: string }> }) {
  const [id, setId] = useState<number | null>(null);
  const searchParams = useSearchParams();
  const level = (searchParams.get('level') || 'regions') as MapLevel;

  const [entity, setEntity] = useState<any>(null);
  const [productions, setProductions] = useState<any[]>([]);
  const [children, setChildren] = useState<any[]>([]);
  const [infrastructures, setInfrastructures] = useState<any[]>([]);
  const [filieres, setFilieres] = useState<any[]>([]);
  const [categories, setCategories] = useState<any[]>([]);
  const [produits, setProduits] = useState<any[]>([]);
  const [geoData, setGeoData] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [partialError, setPartialError] = useState<string | null>(null);

  // FIX: Résoudre la Promise params
  useEffect(() => {
    params.then(resolvedParams => {
      setId(Number(resolvedParams.id));
    });
  }, [params]);

  useEffect(() => {
    if (id === null) return;
    
    let cancelled = false;

    (async () => {
      console.log(`📄 [DetailPage] Loading detail for id=${id} level=${level}`);
      setLoading(true);
      setError(null);
      setPartialError(null);

      try {
        let ent: any, prods: any, kids: any, infras: any, geo: any;
        let fils: any, cats: any, prts: any;

        // Charger les données de base
        const [filieresData, categoriesData, produitsData] = await Promise.all([
          getFilieres(0, 100).catch(e => { console.warn('Filieres load failed:', e); return { items: [] }; }),
          getCategories(0, 100).catch(e => { console.warn('Categories load failed:', e); return { items: [] }; }),
          getProduits(0, 100).catch(e => { console.warn('Produits load failed:', e); return { items: [] }; }),
        ]);

        fils = filieresData.items;
        cats = categoriesData.items;
        prts = produitsData.items;

        switch (level) {
          case 'regions': {
            const results = await Promise.allSettled([
              getRegion(id),
              getRegionProductions(id),
              getRegionDepartements(id),
              getRegionsGeoJSON(),
            ]);

            ent = results[0].status === 'fulfilled' ? results[0].value : null;
            prods = results[1].status === 'fulfilled' ? results[1].value : [];
            kids = results[2].status === 'fulfilled' ? results[2].value : [];
            geo = results[3].status === 'fulfilled' ? results[3].value : null;
            infras = [];

            // Vérifier les erreurs
            const failedResults = results.filter(r => r.status === 'rejected');
            if (failedResults.length > 0 && !ent) {
              throw new Error('Impossible de charger les données de la région');
            }
            if (failedResults.length > 0) {
              setPartialError('Certaines données n\'ont pas pu être chargées');
            }
            break;
          }
          case 'departements': {
            const results = await Promise.allSettled([
              getDepartement(id),
              getDepartementProductions(id),
              getDepartementCommunes(id),
              getDepartementsGeoJSON(),
            ]);

            ent = results[0].status === 'fulfilled' ? results[0].value : null;
            prods = results[1].status === 'fulfilled' ? results[1].value : [];
            kids = results[2].status === 'fulfilled' ? results[2].value : [];
            geo = results[3].status === 'fulfilled' ? results[3].value : null;
            infras = [];

            // Vérifier les erreurs
            const failedResults = results.filter(r => r.status === 'rejected');
            if (failedResults.length > 0 && !ent) {
              throw new Error('Impossible de charger les données du département');
            }
            if (failedResults.length > 0) {
              setPartialError('Certaines données n\'ont pas pu être chargées (notamment les communes)');
              console.warn('Failed to load some data:', failedResults);
            }
            break;
          }
          case 'communes': {
            const results = await Promise.allSettled([
              getCommune(id),
              getCommuneProductions(id),
              getCommuneInfrastructures(id),
              getCommunesGeoJSON(),
            ]);

            ent = results[0].status === 'fulfilled' ? results[0].value : null;
            prods = results[1].status === 'fulfilled' ? results[1].value : [];
            infras = results[2].status === 'fulfilled' ? results[2].value : [];
            geo = results[3].status === 'fulfilled' ? results[3].value : null;
            kids = [];

            // Vérifier les erreurs
            const failedResults = results.filter(r => r.status === 'rejected');
            if (failedResults.length > 0 && !ent) {
              throw new Error('Impossible de charger les données de la commune');
            }
            if (failedResults.length > 0) {
              setPartialError('Certaines données n\'ont pas pu être chargées');
            }
            break;
          }
          default:
            throw new Error('Level inconnu');
        }

        if (cancelled) return;

        setEntity(ent);
        setProductions(Array.isArray(prods) ? prods : (prods?.items || []));
        setChildren(Array.isArray(kids) ? kids : (kids?.items || []));
        setInfrastructures(Array.isArray(infras) ? infras : (infras?.items || []));
        setFilieres(fils);
        setCategories(cats);
        setProduits(prts);
        setGeoData(geo);

        console.log(`✅ [DetailPage] All data loaded for ${ent?.nom}`);
      } catch (e: any) {
        if (!cancelled) {
          console.error('❌ [DetailPage] fetch error', e);
          setError(e.message || 'Erreur de chargement');
        }
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();

    return () => { cancelled = true; };
  }, [id, level]);

  // ── Helpers ──────────────────────────────────────────────────────────────
  const fmt = (n: number | null | undefined) =>
    n != null ? new Intl.NumberFormat('fr-FR').format(n) : '—';
  const fmtFCFA = (n: number | null | undefined) =>
    n != null ? `${new Intl.NumberFormat('fr-FR').format(n)} FCFA` : '—';

  const totalQuantite = productions.reduce((s, p) => s + (p.quantite || 0), 0);
  const totalValeur = productions.reduce((s, p) => s + (p.valeur_fcfa || 0), 0);
  const totalProducteurs = productions.reduce((s, p) => s + (p.nombre_producteurs || 0), 0);
  const totalSuperficie = productions.reduce((s, p) => s + (p.superficie_ha || 0), 0);

  const childLabel = level === 'regions' ? 'Départements' : level === 'departements' ? 'Communes' : '';
  
  const infraIconMap: Record<string, string> = {
    marché: '🏪',
    entrepôt: '🏭',
    coopérative: '🤝',
    usine_transformation: '⚙️',
    point_collecte: '📦',
  };

  // Grouper productions par filière
  const productionsByFiliere = productions.reduce((acc: any, prod: any) => {
    const produit = produits.find(p => p.id === prod.produit_id);
    if (!produit) return acc;
    
    const categorie = categories.find(c => c.id === produit.categorie_id);
    if (!categorie) return acc;
    
    const filiere = filieres.find(f => f.id === categorie.filiere_id);
    if (!filiere) return acc;

    const key = filiere.nom;
    if (!acc[key]) {
      acc[key] = { filiere, total: 0, count: 0 };
    }
    acc[key].total += prod.quantite || 0;
    acc[key].count += 1;
    return acc;
  }, {});

  if (error) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-950 flex items-center justify-center p-6">
        <div className="text-center max-w-md">
          <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
          <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-2">Erreur</h2>
          <p className="text-gray-500 dark:text-gray-400 mb-6">{error}</p>
          <Link href="/map" className="inline-flex items-center gap-2 px-5 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold transition-all">
            <ArrowLeft className="w-4 h-4" /> Retour à la carte
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100">
      {/* Header */}
      <header className="sticky top-0 z-30 bg-white/90 dark:bg-gray-950/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800">
        <div className="max-w-7xl mx-auto px-4 md:px-6 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Link href="/map" className="p-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
              <ArrowLeft className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </Link>
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 bg-gradient-to-br from-green-400 to-emerald-600 rounded-lg flex items-center justify-center">
                <Leaf className="w-4 h-4 text-white" />
              </div>
              <div>
                <span className="text-sm font-bold text-gray-900 dark:text-white">
                  {loading ? '…' : entity?.nom}
                </span>
                <span className="text-xs text-gray-400 dark:text-gray-500 ml-2 capitalize">
                  ({level.slice(0, -1)})
                </span>
              </div>
            </div>
          </div>
          <ThemeToggle />
        </div>
      </header>

      {/* Avertissement d'erreur partielle */}
      {partialError && !loading && (
        <div className="max-w-7xl mx-auto px-4 md:px-6 py-4">
          <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 flex items-start gap-3">
            <AlertCircle className="w-5 h-5 text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5" />
            <div>
              <h4 className="font-semibold text-yellow-800 dark:text-yellow-200 text-sm">Chargement partiel</h4>
              <p className="text-yellow-700 dark:text-yellow-300 text-sm mt-1">{partialError}</p>
            </div>
          </div>
        </div>
      )}

      {loading ? (
        /* Skeleton */
        <div className="max-w-7xl mx-auto px-4 md:px-6 py-8 space-y-6">
          <div className="h-80 bg-gray-200 dark:bg-gray-800 rounded-2xl animate-pulse" />
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
            {[1, 2, 3, 4].map(i => (
              <div key={i} className="h-32 bg-gray-200 dark:bg-gray-800 rounded-xl animate-pulse" />
            ))}
          </div>
        </div>
      ) : (
        <main className="max-w-7xl mx-auto px-4 md:px-6 py-6 space-y-6">
          {/* Carte hero */}
          {geoData && (
            <div className="anim-fadeIn rounded-2xl overflow-hidden shadow-xl border border-gray-200 dark:border-gray-800" style={{ height: '400px' }}>
              <DetailMap geoData={geoData} targetId={id!} />
            </div>
          )}

          {/* KPI Cards */}
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
            {[
              { label: 'Population', value: fmt(entity?.population), icon: Users, color: 'from-blue-400 to-blue-600', delay: 'delay-50' },
              { label: 'Superficie', value: entity?.superficie_km2 ? `${fmt(entity.superficie_km2)} km²` : '—', icon: Layers, color: 'from-emerald-400 to-emerald-600', delay: 'delay-100' },
              { label: 'Productions', value: fmt(productions.length), icon: Wheat, color: 'from-green-400 to-green-600', delay: 'delay-150' },
              { label: 'Valeur totale', value: fmtFCFA(totalValeur), icon: TrendingUp, color: 'from-purple-400 to-purple-600', delay: 'delay-200' },
            ].map((kpi, i) => {
              const Icon = kpi.icon;
              return (
                <div key={i} className={`anim-slideUp ${kpi.delay} bg-white dark:bg-gray-900 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-800 hover:shadow-md transition-shadow`}>
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-9 h-9 rounded-lg bg-gradient-to-br ${kpi.color} flex items-center justify-center`}>
                      <Icon className="w-4.5 h-4.5 text-white" />
                    </div>
                  </div>
                  <p className="text-lg font-display font-bold text-gray-900 dark:text-white truncate">{kpi.value}</p>
                  <p className="text-xs text-gray-400 dark:text-gray-500 mt-0.5">{kpi.label}</p>
                </div>
              );
            })}
          </div>

          {/* Productions par filière */}
          {Object.keys(productionsByFiliere).length > 0 && (
            <div className="anim-slideUp delay-250 bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-5">
              <h3 className="text-sm font-display font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                <Wheat className="w-4 h-4 text-green-500" /> Productions par filière
              </h3>
              <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {Object.entries(productionsByFiliere).map(([nom, data]: [string, any], i) => (
                  <div key={i} className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg p-4 border border-green-200 dark:border-green-800">
                    <div className="flex items-center gap-2 mb-2">
                      <div className="w-8 h-8 rounded-full flex items-center justify-center text-lg" style={{ backgroundColor: data.filiere.couleur || '#22c55e' }}>
                        {data.filiere.icone || '🌾'}
                      </div>
                      <h4 className="font-semibold text-gray-800 dark:text-gray-200">{nom}</h4>
                    </div>
                    <p className="text-2xl font-bold text-green-600 dark:text-green-400">{fmt(data.total)}</p>
                    <p className="text-xs text-gray-500 dark:text-gray-400">{data.count} production{data.count > 1 ? 's' : ''}</p>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Entity info */}
          <div className="anim-slideUp delay-300 bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-5">
            <h3 className="text-sm font-display font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
              <MapPin className="w-4 h-4 text-green-500" /> Informations générales
            </h3>
            <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-3">
              {entity && Object.entries(entity).map(([k, v]) => {
                if (['id', 'created_at', 'updated_at'].includes(k) || v == null) return null;
                return (
                  <div key={k} className="flex flex-col">
                    <span className="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide">{k.replace(/_/g, ' ')}</span>
                    <span className="text-sm font-semibold text-gray-800 dark:text-gray-200">
                      {Array.isArray(v) ? v.join(', ') : String(v)}
                    </span>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Children & Infrastructures */}
          <div className="grid md:grid-cols-2 gap-4 lg:gap-6">
            {childLabel && (
              <div className="anim-slideUp delay-350 bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-5">
                <h3 className="text-sm font-display font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                  <Layers className="w-4 h-4 text-green-500" /> {childLabel} <span className="text-green-500">({children.length})</span>
                </h3>
                {children.length === 0 ? (
                  <p className="text-sm text-gray-400 dark:text-gray-500 italic">Aucune donnée</p>
                ) : (
                  <div className="space-y-2 max-h-56 overflow-y-auto scrollbar-thin pr-1">
                    {children.map((c: any, i: number) => (
                      <div key={c.id || i} className="flex items-center justify-between bg-gray-50 dark:bg-gray-800 rounded-lg px-3 py-2">
                        <span className="text-sm font-medium text-gray-700 dark:text-gray-300">{c.nom}</span>
                        {c.population && <span className="text-xs text-gray-400 dark:text-gray-500">{fmt(c.population)} hab.</span>}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            <div className="anim-slideUp delay-400 bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-5">
              <h3 className="text-sm font-display font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                <Package className="w-4 h-4 text-green-500" /> Infrastructures <span className="text-green-500">({infrastructures.length})</span>
              </h3>
              {infrastructures.length === 0 ? (
                <p className="text-sm text-gray-400 dark:text-gray-500 italic">Aucune infrastructure</p>
              ) : (
                <div className="space-y-2 max-h-56 overflow-y-auto scrollbar-thin pr-1">
                  {infrastructures.map((inf: any, i: number) => (
                    <div key={inf.id || i} className="flex items-start gap-3 bg-gray-50 dark:bg-gray-800 rounded-lg px-3 py-2">
                      <span className="text-lg">{infraIconMap[inf.type_infrastructure] || '🏗️'}</span>
                      <div className="min-w-0">
                        <p className="text-sm font-semibold text-gray-700 dark:text-gray-300 truncate">{inf.nom}</p>
                        {inf.type_infrastructure && (
                          <p className="text-xs text-gray-400 dark:text-gray-500 capitalize">
                            {inf.type_infrastructure.replace(/_/g, ' ')}
                          </p>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Productions table */}
          {productions.length > 0 && (
            <div className="anim-slideUp delay-450 bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-5">
              <h3 className="text-sm font-display font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                <BarChart2 className="w-4 h-4 text-green-500" /> Productions détaillées <span className="text-green-500">({productions.length})</span>
              </h3>
              <div className="overflow-x-auto rounded-lg border border-gray-100 dark:border-gray-800">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="bg-gray-50 dark:bg-gray-800 text-left">
                      <th className="px-3 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Année</th>
                      <th className="px-3 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Quantité</th>
                      <th className="px-3 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Valeur</th>
                      <th className="px-3 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Producteurs</th>
                      <th className="px-3 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Superficie</th>
                    </tr>
                  </thead>
                  <tbody>
                    {productions.slice(0, 20).map((p: any, i: number) => (
                      <tr key={p.id || i} className="border-t border-gray-100 dark:border-gray-800 hover:bg-green-50/40 dark:hover:bg-green-900/20 transition-colors">
                        <td className="px-3 py-2 font-semibold text-gray-700 dark:text-gray-300">{p.annee}</td>
                        <td className="px-3 py-2 text-gray-600 dark:text-gray-400">{fmt(p.quantite)}</td>
                        <td className="px-3 py-2 text-gray-600 dark:text-gray-400">{fmtFCFA(p.valeur_fcfa)}</td>
                        <td className="px-3 py-2 text-gray-600 dark:text-gray-400">{fmt(p.nombre_producteurs)}</td>
                        <td className="px-3 py-2 text-gray-500 dark:text-gray-500">{p.superficie_ha ? `${fmt(p.superficie_ha)} ha` : '—'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Producteurs summary */}
          {totalProducteurs > 0 && (
            <div className="anim-slideUp delay-500 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl border border-green-200 dark:border-green-800 p-5 flex items-center gap-5">
              <div className="w-14 h-14 rounded-full bg-green-100 dark:bg-green-800/40 flex items-center justify-center flex-shrink-0">
                <Users className="w-7 h-7 text-green-600 dark:text-green-300" />
              </div>
              <div>
                <p className="text-2xl font-display font-extrabold text-gray-900 dark:text-white">{fmt(totalProducteurs)}</p>
                <p className="text-sm text-gray-500 dark:text-gray-400">Producteurs répertoriés</p>
              </div>
            </div>
          )}
        </main>
      )}
    </div>
  );
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\app\map\page.tsx
================================================================================

'use client';

import { useState, useEffect, useCallback, useRef, useMemo } from 'react';
import dynamic from 'next/dynamic';
import Link from 'next/link';
import { ArrowLeft, Leaf, BarChart3 } from 'lucide-react';
import ThemeToggle from '@/components/ThemeToggle';
import type { GeoJSONFeatureCollection, MapLevel } from '@/types/api';
import {
  getRegionsGeoJSON, getDepartementsGeoJSON, getCommunesGeoJSON,
  getRegion, getDepartement, getCommuneResume,
  getRegionProductions, getDepartementProductions,
  getProductions,
} from '@/lib/api';

// ✨ Chargement dynamique sans SSR
const MapView = dynamic(() => import('@/components/MapView'), {
  ssr: false,
  loading: () => (
    <div className="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-950 flex items-center justify-center rounded-xl">
      <div className="text-center">
        <div className="inline-block w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin mb-4" />
        <p className="text-gray-600 dark:text-gray-400 text-base font-semibold animate-pulse">
          Chargement de la carte…
        </p>
      </div>
    </div>
  ),
});

const Sidebar = dynamic(() => import('@/components/Sidebar'), {
  ssr: false,
  loading: () => (
    <div className="w-full h-full bg-white dark:bg-gray-950 border-r border-gray-200 dark:border-gray-800 flex items-center justify-center">
      <div className="inline-block w-8 h-8 border-3 border-green-500 border-t-transparent rounded-full animate-spin" />
    </div>
  ),
});

export default function MapPage() {
  const [mapLevel, setMapLevel] = useState<MapLevel>('regions');
  const [geoData, setGeoData] = useState<GeoJSONFeatureCollection | null>(null);
  const [loading, setLoading] = useState(true);
  const [selectedEntity, setSelectedEntity] = useState<any>(null);
  const [selectedFeatureId, setSelectedFeatureId] = useState<number | null>(null);

  const [filters, setFilters] = useState({
    filiere_id: null as number | null,
    categorie_id: null as number | null,
    produit_id: null as number | null,
    annee: null as number | null,
  });

  // Cache pour GeoJSON de base (sans enrichissement)
  const baseGeoDataCache = useRef<Map<MapLevel, GeoJSONFeatureCollection>>(new Map());
  
  // Debounce timer
  const debounceTimer = useRef<NodeJS.Timeout>();

  // ── Load GeoJSON optimisé avec cache local ──────────────────────────────────
  const loadGeoData = useCallback(async () => {
    const startTime = performance.now();
    console.log(
      `%c🗺️  [MapPage] Loading GeoJSON for level: ${mapLevel}`,
      'color: #3b82f6; font-weight: bold',
      filters
    );
    
    setLoading(true);
    
    try {
      let baseData: GeoJSONFeatureCollection;
      
      // Vérifier le cache local d'abord
      const cached = baseGeoDataCache.current.get(mapLevel);
      if (cached && !filters.produit_id && !filters.filiere_id && !filters.annee) {
        console.log('%c⚡ Using cached base GeoJSON', 'color: #10b981; font-weight: bold');
        baseData = cached;
      } else {
        // Charger depuis l'API (avec cache HTTP)
        switch (mapLevel) {
          case 'regions':
            baseData = await getRegionsGeoJSON();
            break;
          case 'departements':
            baseData = await getDepartementsGeoJSON(filters.filiere_id || undefined);
            break;
          case 'communes':
            baseData = await getCommunesGeoJSON();
            break;
          default:
            baseData = await getRegionsGeoJSON();
        }
        
        // Mettre en cache si pas de filtres
        if (!filters.produit_id && !filters.filiere_id && !filters.annee) {
          baseGeoDataCache.current.set(mapLevel, baseData);
        }
      }

      // Enrichir avec les productions seulement si nécessaire
      if (filters.produit_id || filters.filiere_id || filters.annee) {
        console.log('%c📊 Enriching with production data...', 'color: #8b5cf6; font-weight: bold');
        
        const productionsData = await getProductions({
          filiere_id: filters.filiere_id,
          categorie_id: filters.categorie_id,
          produit_id: filters.produit_id,
          annee: filters.annee,
          limit: 500,
        });

        const productions = productionsData.items || [];

        // Grouper par zone de manière optimisée
        const productionsByZone = new Map<number, {total: number; count: number}>();
        
        for (const prod of productions) {
          let zoneId: number | null = null;
          
          if (mapLevel === 'regions') zoneId = prod.region_id;
          else if (mapLevel === 'departements') zoneId = prod.departement_id;
          else if (mapLevel === 'communes') zoneId = prod.commune_id;

          if (!zoneId) continue;

          const existing = productionsByZone.get(zoneId) || { total: 0, count: 0 };
          existing.total += prod.quantite || 0;
          existing.count += 1;
          productionsByZone.set(zoneId, existing);
        }

        // Enrichir features de manière optimisée
        baseData = {
          ...baseData,
          features: baseData.features.map(feature => {
            const prodData = productionsByZone.get(feature.properties.id);
            return {
              ...feature,
              properties: {
                ...feature.properties,
                production_total: prodData?.total || 0,
                production_count: prodData?.count || 0,
              },
            };
          }),
        };

        console.log(`%c✅ Enriched ${baseData.features.length} features`, 'color: #22c55e; font-weight: bold');
      }

      setGeoData(baseData);
      
      const elapsed = (performance.now() - startTime).toFixed(1);
      console.log(`%c✅ GeoJSON ready in ${elapsed}ms`, 'color: #22c55e; font-weight: bold');
    } catch (e) {
      console.error('%c❌ GeoJSON load failed:', 'color: #ef4444; font-weight: bold', e);
    } finally {
      setLoading(false);
    }
  }, [mapLevel, filters]);

  // Debounced load
  useEffect(() => {
    // Clear existing timer
    if (debounceTimer.current) {
      clearTimeout(debounceTimer.current);
    }

    // Si changement de niveau, charger immédiatement
    if (!filters.produit_id && !filters.filiere_id && !filters.annee) {
      loadGeoData();
    } else {
      // Sinon, debounce de 300ms pour les filtres
      debounceTimer.current = setTimeout(() => {
        loadGeoData();
      }, 300);
    }

    return () => {
      if (debounceTimer.current) {
        clearTimeout(debounceTimer.current);
      }
    };
  }, [mapLevel, filters, loadGeoData]);

  // ── Feature click ─────────────────────────────────────────────────────────
  const handleFeatureClick = useCallback(async (properties: any) => {
    console.log(`%c🖱️  Feature clicked:`, 'color: #8b5cf6; font-weight: bold', properties);
    setSelectedFeatureId(properties.id);
    
    try {
      let entityData: any;
      
      switch (mapLevel) {
        case 'regions': {
          entityData = await getRegion(properties.id);
          if (filters.produit_id || filters.annee) {
            const prods = await getRegionProductions(
              properties.id,
              filters.annee || undefined,
              filters.produit_id || undefined
            );
            entityData = { ...entityData, productions: prods };
          }
          break;
        }
        case 'departements': {
          entityData = await getDepartement(properties.id);
          if (filters.produit_id || filters.annee) {
            const prods = await getDepartementProductions(
              properties.id,
              filters.annee || undefined,
              filters.produit_id || undefined
            );
            entityData = { ...entityData, productions: prods };
          }
          break;
        }
        case 'communes':
          entityData = await getCommuneResume(properties.id);
          break;
        default:
          entityData = properties;
      }
      
      setSelectedEntity(entityData);
      console.log('%c✅ Entity loaded', 'color: #22c55e; font-weight: bold');
    } catch (e) {
      console.error('%c❌ Detail fetch failed:', 'color: #ef4444; font-weight: bold', e);
      setSelectedEntity(properties);
    }
  }, [mapLevel, filters]);

  const handleFilterChange = useCallback((nf: any) => {
    console.log('%c🔄 Filters changing:', 'color: #f59e0b; font-weight: bold', nf);
    setFilters(nf);
  }, []);

  const handleMapLevelChange = useCallback((level: MapLevel) => {
    console.log(`%c🗺️  Map level changing to: ${level}`, 'color: #3b82f6; font-weight: bold');
    setMapLevel(level);
    setSelectedEntity(null);
    setSelectedFeatureId(null);
  }, []);

  // Mémoriser le nombre de zones
  const zoneCount = useMemo(() => geoData?.features.length || 0, [geoData]);

  return (
    <div className="h-screen flex flex-col bg-white dark:bg-gray-950">
      {/* Header */}
      <header className="flex-shrink-0 bg-white/95 dark:bg-gray-950/95 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 z-10">
        <div className="px-4 md:px-6 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Link href="/" className="p-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
              <ArrowLeft className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </Link>
            <div className="flex items-center gap-2.5">
              <div className="w-9 h-9 bg-gradient-to-br from-green-400 to-emerald-600 rounded-xl flex items-center justify-center shadow-lg">
                <Leaf className="w-5 h-5 text-white" />
              </div>
              <div>
                <h1 className="text-base font-display font-bold text-gray-900 dark:text-white leading-tight">
                  AgriVision
                </h1>
                <p className="text-xs text-gray-500 dark:text-gray-400 capitalize flex items-center gap-1">
                  <span className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse" />
                  {mapLevel}
                </p>
              </div>
            </div>
          </div>

          <div className="flex items-center gap-2">
            <Link
              href="/stats"
              className="hidden sm:flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg text-sm font-medium transition-all shadow-md hover:shadow-lg"
            >
              <BarChart3 className="w-4 h-4" /> Stats
            </Link>
            <div className="px-3 py-1 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg border border-green-200 dark:border-green-800">
              <span className="text-xs font-semibold">
                {loading ? '…' : `${zoneCount} zones`}
              </span>
            </div>
            <ThemeToggle />
          </div>
        </div>
      </header>

      {/* Body */}
      <div className="flex-1 flex overflow-hidden">
        {/* Sidebar */}
        <div className="w-80 lg:w-96 flex-shrink-0 overflow-hidden border-r border-gray-200 dark:border-gray-800">
          <Sidebar
            onFilterChange={handleFilterChange}
            onMapLevelChange={handleMapLevelChange}
            selectedEntity={selectedEntity}
            currentMapLevel={mapLevel}
          />
        </div>

        {/* Map */}
        <div className="flex-1 p-3 md:p-5 overflow-hidden bg-gradient-to-br from-gray-50 to-white dark:from-gray-950 dark:to-gray-900">
          <MapView
            geoData={geoData}
            loading={loading}
            mapLevel={mapLevel}
            onFeatureClick={handleFeatureClick}
            selectedFeatureId={selectedFeatureId}
          />
        </div>
      </div>
    </div>
  );
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\app\stats\page.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import {
  ArrowLeft, Leaf, TrendingUp, TrendingDown, BarChart3,
  Calendar, MapPin, Package, Users, Award, Activity,
  PieChart, LineChart, Database, Sparkles, ChevronDown,
  Filter, RefreshCw, Download, Eye, EyeOff,
} from 'lucide-react';
import {
  LineChart as RechartsLine,
  Line,
  BarChart as RechartsBar,
  Bar,
  PieChart as RechartsPie,
  Pie,
  Cell,
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  RadialBarChart,
  RadialBar,
  ComposedChart,
} from 'recharts';
import ThemeToggle from '@/components/ThemeToggle';
import {
  getStatistiquesGlobales,
  getStatistiquesProduction,
  getEvolutionProduction,
  getTopRegions,
  getTopProduits,
  comparerAnnees,
  getAnneesDisponibles,
  getFilieres,
  getProduits,
  getBassins,
  getProductionsParAnnee,
  getProductionsParRegion,
  getProductionsParProduit,
} from '@/lib/api';
import { SkeletonStat } from '@/components/Skeleton';

// Couleurs pour les graphiques
const COLORS = [
  '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#3b82f6',
  '#6366f1', '#8b5cf6', '#a855f7', '#ec4899', '#f43f5e',
];

const GRADIENT_COLORS = [
  { start: '#22c55e', end: '#10b981' },
  { start: '#3b82f6', end: '#06b6d4' },
  { start: '#f59e0b', end: '#ef4444' },
  { start: '#8b5cf6', end: '#ec4899' },
];

export default function StatsPage() {
  // États pour les données
  const [statsGlobales, setStatsGlobales] = useState<any>(null);
  const [statsProduction, setStatsProduction] = useState<any>(null);
  const [evolution, setEvolution] = useState<any[]>([]);
  const [topRegions, setTopRegions] = useState<any[]>([]);
  const [topProduits, setTopProduits] = useState<any[]>([]);
  const [comparaison, setComparaison] = useState<any>(null);
  const [productionsParAnnee, setProductionsParAnnee] = useState<any[]>([]);
  const [productionsParRegion, setProductionsParRegion] = useState<any[]>([]);
  const [productionsParProduit, setProductionsParProduit] = useState<any[]>([]);
  
  // États pour les filtres
  const [annees, setAnnees] = useState<number[]>([]);
  const [filieres, setFilieres] = useState<any[]>([]);
  const [produits, setProduits] = useState<any[]>([]);
  const [bassins, setBassins] = useState<any[]>([]);

  const [selectedAnnee, setSelectedAnnee] = useState<number | null>(null);
  const [selectedFiliere, setSelectedFiliere] = useState<number | null>(null);
  const [selectedProduit, setSelectedProduit] = useState<number | null>(null);
  const [selectedBassin, setSelectedBassin] = useState<number | null>(null);
  const [anneeRef, setAnneeRef] = useState<number | null>(null);
  const [anneeCmp, setAnneeCmp] = useState<number | null>(null);

  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'overview' | 'evolution' | 'distribution' | 'comparison' | 'bassins'>('overview');
  const [showFilters, setShowFilters] = useState(true);

  useEffect(() => {
    loadInitialData();
  }, []);

  useEffect(() => {
    if (selectedAnnee || selectedFiliere || selectedProduit || selectedBassin) {
      loadFilteredData();
    }
  }, [selectedAnnee, selectedFiliere, selectedProduit, selectedBassin]);

  useEffect(() => {
    if (anneeRef && anneeCmp && anneeRef !== anneeCmp) {
      loadComparaison();
    }
  }, [anneeRef, anneeCmp]);

  const loadInitialData = async () => {
    console.log('📊 [StatsPage] Loading initial data...');
    setLoading(true);

    try {
      const [
        globales,
        production,
        anneesData,
        filieresData,
        produitsData,
        bassinsData,
        parAnnee,
        parRegion,
        parProduit,
      ] = await Promise.all([
        getStatistiquesGlobales(),
        getStatistiquesProduction(),
        getAnneesDisponibles(),
        getFilieres(0, 100),
        getProduits(0, 100),
        getBassins(0, 100),
        getProductionsParAnnee(),
        getProductionsParRegion(),
        getProductionsParProduit(),
      ]);

      setStatsGlobales(globales);
      setStatsProduction(production);
      setAnnees(anneesData.sort((a: number, b: number) => b - a));
      setFilieres(filieresData.items);
      setProduits(produitsData.items);
      setBassins(bassinsData.items);
      setProductionsParAnnee(parAnnee);
      setProductionsParRegion(parRegion);
      setProductionsParProduit(parProduit);

      // Charger top regions et produits
      const [regions, products] = await Promise.all([
        getTopRegions(undefined, undefined, 10),
        getTopProduits(undefined, undefined, 10),
      ]);

      setTopRegions(regions);
      setTopProduits(products);

      console.log('✅ [StatsPage] Initial data loaded');
    } catch (error) {
      console.error('❌ [StatsPage] Error loading data:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadFilteredData = async () => {
    console.log('🔄 [StatsPage] Loading filtered data...');
    
    try {
      const [evo, regions, products, parAnnee, parRegion, parProduit] = await Promise.all([
        getEvolutionProduction(selectedProduit || undefined, undefined, undefined, undefined),
        getTopRegions(selectedAnnee || undefined, selectedProduit || undefined, 10),
        getTopProduits(selectedAnnee || undefined, undefined, 10),
        getProductionsParAnnee(selectedProduit || undefined, undefined, undefined, undefined),
        getProductionsParRegion(selectedAnnee || undefined, selectedProduit || undefined),
        getProductionsParProduit(selectedAnnee || undefined, undefined),
      ]);

      setEvolution(evo);
      setTopRegions(regions);
      setTopProduits(products);
      setProductionsParAnnee(parAnnee);
      setProductionsParRegion(parRegion);
      setProductionsParProduit(parProduit);

      console.log('✅ [StatsPage] Filtered data loaded');
    } catch (error) {
      console.error('❌ [StatsPage] Error loading filtered data:', error);
    }
  };

  const loadComparaison = async () => {
    if (!anneeRef || !anneeCmp) return;

    console.log(`🔄 [StatsPage] Comparing years ${anneeRef} vs ${anneeCmp}`);

    try {
      const comp = await comparerAnnees(anneeRef, anneeCmp, selectedProduit || undefined);
      setComparaison(comp);
      console.log('✅ [StatsPage] Comparison loaded');
    } catch (error) {
      console.error('❌ [StatsPage] Error loading comparison:', error);
    }
  };

  const fmt = (n: number | null | undefined) =>
    n != null ? new Intl.NumberFormat('fr-FR').format(n) : '—';

  const fmtFCFA = (n: number | null | undefined) =>
    n != null ? `${new Intl.NumberFormat('fr-FR').format(n)} FCFA` : '—';

  const tabs = [
    { id: 'overview', label: 'Vue d\'ensemble', icon: Activity },
    { id: 'evolution', label: 'Évolution', icon: TrendingUp },
    { id: 'distribution', label: 'Distribution', icon: PieChart },
    { id: 'comparison', label: 'Comparaison', icon: BarChart3 },
    { id: 'bassins', label: 'Bassins', icon: MapPin },
  ] as const;

  // Custom Tooltip
  const CustomTooltip = ({ active, payload, label }: any) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white dark:bg-gray-800 p-3 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
          <p className="font-semibold text-gray-900 dark:text-white mb-1">{label}</p>
          {payload.map((entry: any, index: number) => (
            <p key={index} className="text-sm" style={{ color: entry.color }}>
              {entry.name}: {fmt(entry.value)}
            </p>
          ))}
        </div>
      );
    }
    return null;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-white via-green-50 to-emerald-50 dark:from-gray-950 dark:via-gray-900 dark:to-gray-950">
      {/* Header */}
      <header className="sticky top-0 z-30 bg-white/90 dark:bg-gray-950/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800">
        <div className="max-w-[1600px] mx-auto px-4 md:px-6 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Link href="/" className="p-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
              <ArrowLeft className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </Link>
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 bg-gradient-to-br from-green-400 to-emerald-600 rounded-lg flex items-center justify-center">
                <BarChart3 className="w-4 h-4 text-white" />
              </div>
              <div>
                <h1 className="text-sm font-bold text-gray-900 dark:text-white">Statistiques Avancées</h1>
                <p className="text-xs text-gray-500 dark:text-gray-400">Analyse des productions agricoles</p>
              </div>
            </div>
          </div>
          
          <div className="flex items-center gap-2">
            <button
              onClick={() => setShowFilters(!showFilters)}
              className="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all"
            >
              <Filter className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </button>
            <button
              onClick={loadInitialData}
              className="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all"
              disabled={loading}
            >
              <RefreshCw className={`w-5 h-5 text-gray-600 dark:text-gray-300 ${loading ? 'animate-spin' : ''}`} />
            </button>
            <ThemeToggle />
          </div>
        </div>
      </header>

      {/* Filters */}
      {showFilters && (
        <div className="max-w-[1600px] mx-auto px-4 md:px-6 py-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 animate-slideDown">
          <div className="grid sm:grid-cols-2 lg:grid-cols-5 gap-3">
            <div>
              <label className="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 flex items-center gap-1">
                <Calendar className="w-3 h-3" /> Année
              </label>
              <select
                value={selectedAnnee || ''}
                onChange={e => setSelectedAnnee(e.target.value ? Number(e.target.value) : null)}
                className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm focus:ring-2 focus:ring-green-500 outline-none"
              >
                <option value="">Toutes les années</option>
                {annees.map(a => <option key={a} value={a}>{a}</option>)}
              </select>
            </div>

            <div>
              <label className="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 flex items-center gap-1">
                <Leaf className="w-3 h-3" /> Filière
              </label>
              <select
                value={selectedFiliere || ''}
                onChange={e => setSelectedFiliere(e.target.value ? Number(e.target.value) : null)}
                className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm focus:ring-2 focus:ring-green-500 outline-none"
              >
                <option value="">Toutes les filières</option>
                {filieres.map(f => <option key={f.id} value={f.id}>{f.nom}</option>)}
              </select>
            </div>

            <div>
              <label className="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 flex items-center gap-1">
                <Package className="w-3 h-3" /> Produit
              </label>
              <select
                value={selectedProduit || ''}
                onChange={e => setSelectedProduit(e.target.value ? Number(e.target.value) : null)}
                className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm focus:ring-2 focus:ring-green-500 outline-none"
              >
                <option value="">Tous les produits</option>
                {produits.map(p => <option key={p.id} value={p.id}>{p.nom}</option>)}
              </select>
            </div>

            <div>
              <label className="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1 flex items-center gap-1">
                <MapPin className="w-3 h-3" /> Bassin
              </label>
              <select
                value={selectedBassin || ''}
                onChange={e => setSelectedBassin(e.target.value ? Number(e.target.value) : null)}
                className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm focus:ring-2 focus:ring-green-500 outline-none"
              >
                <option value="">Tous les bassins</option>
                {bassins.map(b => <option key={b.id} value={b.id}>{b.nom}</option>)}
              </select>
            </div>

            <div className="flex items-end">
              <button
                onClick={() => {
                  setSelectedAnnee(null);
                  setSelectedFiliere(null);
                  setSelectedProduit(null);
                  setSelectedBassin(null);
                  loadInitialData();
                }}
                className="w-full px-3 py-2 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium transition-all"
              >
                Réinitialiser
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Tabs */}
      <div className="max-w-[1600px] mx-auto px-4 md:px-6 py-4">
        <div className="flex gap-2 overflow-x-auto scrollbar-thin pb-2">
          {tabs.map(tab => {
            const Icon = tab.icon;
            const isActive = activeTab === tab.id;
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex items-center gap-2 px-4 py-2.5 rounded-lg font-medium whitespace-nowrap transition-all ${
                  isActive
                    ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow-lg scale-105'
                    : 'bg-white dark:bg-gray-900 text-gray-600 dark:text-gray-400 hover:bg-green-50 dark:hover:bg-green-900/20 border border-gray-200 dark:border-gray-800'
                }`}
              >
                <Icon className="w-4 h-4" />
                {tab.label}
              </button>
            );
          })}
        </div>
      </div>

      {/* Content */}
      <div className="max-w-[1600px] mx-auto px-4 md:px-6 py-6 pb-12">
        {loading ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {[1, 2, 3, 4, 5, 6, 7, 8].map(i => <SkeletonStat key={i} />)}
          </div>
        ) : (
          <>
            {/* Overview Tab */}
            {activeTab === 'overview' && (
              <div className="space-y-6 animate-fadeIn">
                {/* KPI Cards */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  {[
                    { 
                      label: 'Régions', 
                      value: statsGlobales?.total_regions, 
                      icon: MapPin, 
                      gradient: 'from-blue-400 to-blue-600',
                      trend: '+2%'
                    },
                    { 
                      label: 'Filières', 
                      value: statsGlobales?.total_filieres, 
                      icon: Leaf, 
                      gradient: 'from-green-400 to-green-600',
                      trend: 'Stable'
                    },
                    { 
                      label: 'Produits', 
                      value: statsGlobales?.total_produits, 
                      icon: Package, 
                      gradient: 'from-purple-400 to-purple-600',
                      trend: '+12%'
                    },
                    { 
                      label: 'Productions', 
                      value: statsGlobales?.total_productions, 
                      icon: TrendingUp, 
                      gradient: 'from-orange-400 to-orange-600',
                      trend: '+8%'
                    },
                  ].map((stat, i) => {
                    const Icon = stat.icon;
                    return (
                      <div 
                        key={i} 
                        className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm hover:shadow-xl transition-all duration-300 animate-slideUp"
                        style={{ animationDelay: `${i * 50}ms` }}
                      >
                        <div className="flex items-center justify-between mb-4">
                          <div className={`p-3 rounded-xl bg-gradient-to-br ${stat.gradient} shadow-lg`}>
                            <Icon className="w-6 h-6 text-white" />
                          </div>
                          <span className="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">
                            {stat.trend}
                          </span>
                        </div>
                        <div className="text-3xl font-bold text-gray-900 dark:text-white mb-1 font-display">
                          {fmt(stat.value)}
                        </div>
                        <div className="text-sm text-gray-600 dark:text-gray-400">{stat.label}</div>
                      </div>
                    );
                  })}
                </div>

                {/* Charts Grid */}
                <div className="grid lg:grid-cols-2 gap-6">
                  {/* Production Stats Card */}
                  {statsProduction && (
                    <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm animate-slideUp">
                      <div className="flex items-center gap-2 mb-6">
                        <Database className="w-5 h-5 text-green-500" />
                        <h2 className="text-lg font-bold text-gray-900 dark:text-white">Statistiques de production</h2>
                      </div>
                      <div className="grid sm:grid-cols-2 gap-4">
                        {Object.entries(statsProduction).slice(0, 6).map(([key, value]: [string, any], idx) => (
                          <div key={key} className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl p-4 border border-green-200 dark:border-green-800">
                            <div className="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">
                              {key.replace(/_/g, ' ')}
                            </div>
                            <div className="text-2xl font-bold text-gray-900 dark:text-white">
                              {typeof value === 'number' ? fmt(value) : String(value)}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Bassins Pie Chart */}
                  {bassins.length > 0 && (
                    <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm animate-slideUp">
                      <div className="flex items-center gap-2 mb-6">
                        <PieChart className="w-5 h-5 text-green-500" />
                        <h2 className="text-lg font-bold text-gray-900 dark:text-white">Répartition des bassins</h2>
                      </div>
                      <ResponsiveContainer width="100%" height={300}>
                        <RechartsPie>
                          <Pie
                            data={bassins.slice(0, 8).map((b, i) => ({ name: b.nom, value: i + 1 }))}
                            cx="50%"
                            cy="50%"
                            labelLine={false}
                            label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                            outerRadius={100}
                            fill="#8884d8"
                            dataKey="value"
                          >
                            {bassins.slice(0, 8).map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                            ))}
                          </Pie>
                          <Tooltip content={<CustomTooltip />} />
                        </RechartsPie>
                      </ResponsiveContainer>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Evolution Tab */}
            {activeTab === 'evolution' && (
              <div className="space-y-6 animate-fadeIn">
                {/* Evolution Line Chart */}
                {productionsParAnnee.length > 0 && (
                  <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm">
                    <div className="flex items-center justify-between mb-6">
                      <div className="flex items-center gap-2">
                        <LineChart className="w-5 h-5 text-green-500" />
                        <h2 className="text-lg font-bold text-gray-900 dark:text-white">Évolution de la production</h2>
                      </div>
                      <Sparkles className="w-5 h-5 text-yellow-500" />
                    </div>
                    <ResponsiveContainer width="100%" height={400}>
                      <RechartsLine data={productionsParAnnee}>
                        <defs>
                          <linearGradient id="colorQuantite" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="5%" stopColor="#22c55e" stopOpacity={0.8}/>
                            <stop offset="95%" stopColor="#22c55e" stopOpacity={0.1}/>
                          </linearGradient>
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.1} />
                        <XAxis 
                          dataKey="annee" 
                          stroke="#9ca3af"
                          style={{ fontSize: '12px' }}
                        />
                        <YAxis 
                          stroke="#9ca3af"
                          style={{ fontSize: '12px' }}
                          tickFormatter={(value) => fmt(value)}
                        />
                        <Tooltip content={<CustomTooltip />} />
                        <Legend />
                        <Line 
                          type="monotone" 
                          dataKey="total_quantite" 
                          name="Quantité totale"
                          stroke="#22c55e" 
                          strokeWidth={3}
                          dot={{ fill: '#22c55e', r: 5 }}
                          activeDot={{ r: 8 }}
                        />
                        {productionsParAnnee[0]?.total_valeur_fcfa !== undefined && (
                          <Line 
                            type="monotone" 
                            dataKey="total_valeur_fcfa" 
                            name="Valeur (FCFA)"
                            stroke="#3b82f6" 
                            strokeWidth={3}
                            dot={{ fill: '#3b82f6', r: 5 }}
                          />
                        )}
                      </RechartsLine>
                    </ResponsiveContainer>
                  </div>
                )}

                {/* Area Chart */}
                {evolution.length > 0 && (
                  <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm">
                    <div className="flex items-center gap-2 mb-6">
                      <Activity className="w-5 h-5 text-green-500" />
                      <h2 className="text-lg font-bold text-gray-900 dark:text-white">Tendances détaillées</h2>
                    </div>
                    <ResponsiveContainer width="100%" height={350}>
                      <AreaChart data={evolution}>
                        <defs>
                          <linearGradient id="colorArea" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="5%" stopColor="#10b981" stopOpacity={0.8}/>
                            <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                          </linearGradient>
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.1} />
                        <XAxis dataKey="annee" stroke="#9ca3af" style={{ fontSize: '12px' }} />
                        <YAxis stroke="#9ca3af" style={{ fontSize: '12px' }} />
                        <Tooltip content={<CustomTooltip />} />
                        <Area 
                          type="monotone" 
                          dataKey="total_quantite" 
                          stroke="#10b981" 
                          fillOpacity={1} 
                          fill="url(#colorArea)" 
                        />
                      </AreaChart>
                    </ResponsiveContainer>
                  </div>
                )}
              </div>
            )}

            {/* Distribution Tab */}
            {activeTab === 'distribution' && (
              <div className="space-y-6 animate-fadeIn">
                {/* Regional Distribution */}
                {productionsParRegion.length > 0 && (
                  <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm">
                    <div className="flex items-center gap-2 mb-6">
                      <MapPin className="w-5 h-5 text-green-500" />
                      <h2 className="text-lg font-bold text-gray-900 dark:text-white">Distribution par région</h2>
                    </div>
                    <ResponsiveContainer width="100%" height={400}>
                      <RechartsBar data={productionsParRegion.slice(0, 10)}>
                        <defs>
                          <linearGradient id="barGradient" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="5%" stopColor="#22c55e" stopOpacity={0.9}/>
                            <stop offset="95%" stopColor="#10b981" stopOpacity={0.7}/>
                          </linearGradient>
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.1} />
                        <XAxis 
                          dataKey="nom" 
                          stroke="#9ca3af" 
                          style={{ fontSize: '11px' }}
                          angle={-45}
                          textAnchor="end"
                          height={100}
                        />
                        <YAxis stroke="#9ca3af" style={{ fontSize: '12px' }} />
                        <Tooltip content={<CustomTooltip />} />
                        <Legend />
                        <Bar dataKey="total_quantite" name="Quantité" fill="url(#barGradient)" radius={[8, 8, 0, 0]} />
                      </RechartsBar>
                    </ResponsiveContainer>
                  </div>
                )}

                <div className="grid lg:grid-cols-2 gap-6">
                  {/* Product Distribution Pie */}
                  {productionsParProduit.length > 0 && (
                    <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm">
                      <div className="flex items-center gap-2 mb-6">
                        <Package className="w-5 h-5 text-green-500" />
                        <h2 className="text-lg font-bold text-gray-900 dark:text-white">Distribution par produit</h2>
                      </div>
                      <ResponsiveContainer width="100%" height={350}>
                        <RechartsPie>
                          <Pie
                            data={productionsParProduit.slice(0, 8)}
                            cx="50%"
                            cy="50%"
                            labelLine={true}
                            label={({ nom, percent }) => `${nom} (${(percent * 100).toFixed(0)}%)`}
                            outerRadius={100}
                            fill="#8884d8"
                            dataKey="total_quantite"
                          >
                            {productionsParProduit.slice(0, 8).map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                            ))}
                          </Pie>
                          <Tooltip content={<CustomTooltip />} />
                        </RechartsPie>
                      </ResponsiveContainer>
                    </div>
                  )}

                  {/* Radial Bar Chart */}
                  {topRegions.length > 0 && (
                    <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm">
                      <div className="flex items-center gap-2 mb-6">
                        <Award className="w-5 h-5 text-yellow-500" />
                        <h2 className="text-lg font-bold text-gray-900 dark:text-white">Top régions (radial)</h2>
                      </div>
                      <ResponsiveContainer width="100%" height={350}>
                        <RadialBarChart 
                          cx="50%" 
                          cy="50%" 
                          innerRadius="10%" 
                          outerRadius="90%" 
                          data={topRegions.slice(0, 5).map((r, i) => ({
                            name: r.nom || `Région ${r.region_id}`,
                            value: r.total_quantite,
                            fill: COLORS[i]
                          }))}
                        >
                          <RadialBar
                            minAngle={15}
                            label={{ position: 'insideStart', fill: '#fff' }}
                            background
                            clockWise
                            dataKey="value"
                          />
                          <Legend iconSize={10} layout="vertical" verticalAlign="middle" align="right" />
                          <Tooltip content={<CustomTooltip />} />
                        </RadialBarChart>
                      </ResponsiveContainer>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Comparison Tab */}
            {activeTab === 'comparison' && (
              <div className="space-y-6 animate-fadeIn">
                <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm">
                  <div className="flex items-center gap-2 mb-6">
                    <BarChart3 className="w-5 h-5 text-green-500" />
                    <h2 className="text-lg font-bold text-gray-900 dark:text-white">Comparaison entre années</h2>
                  </div>
                  
                  <div className="grid sm:grid-cols-2 gap-4 mb-6">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Année de référence
                      </label>
                      <select
                        value={anneeRef || ''}
                        onChange={e => setAnneeRef(e.target.value ? Number(e.target.value) : null)}
                        className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-green-500 outline-none"
                      >
                        <option value="">Sélectionner...</option>
                        {annees.map(a => <option key={a} value={a}>{a}</option>)}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Année de comparaison
                      </label>
                      <select
                        value={anneeCmp || ''}
                        onChange={e => setAnneeCmp(e.target.value ? Number(e.target.value) : null)}
                        className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-green-500 outline-none"
                      >
                        <option value="">Sélectionner...</option>
                        {annees.map(a => <option key={a} value={a}>{a}</option>)}
                      </select>
                    </div>
                  </div>

                  {comparaison ? (
                    <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Object.entries(comparaison).map(([key, value]: [string, any]) => {
                        if (key === 'annee_reference' || key === 'annee_comparaison') return null;
                        
                        const isPositive = typeof value === 'number' && value > 0;
                        const TrendIcon = isPositive ? TrendingUp : TrendingDown;
                        
                        return (
                          <div key={key} className="bg-gradient-to-br from-gray-50 to-white dark:from-gray-800 dark:to-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
                            <div className="flex items-center justify-between mb-2">
                              <div className="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">
                                {key.replace(/_/g, ' ')}
                              </div>
                              {typeof value === 'number' && (
                                <TrendIcon className={`w-4 h-4 ${isPositive ? 'text-green-500' : 'text-red-500'}`} />
                              )}
                            </div>
                            <div className="text-2xl font-bold text-gray-900 dark:text-white">
                              {typeof value === 'number' ? fmt(value) : String(value)}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="text-center py-12">
                      <Calendar className="w-16 h-16 text-gray-300 dark:text-gray-700 mx-auto mb-4" />
                      <p className="text-gray-500 dark:text-gray-400">
                        Sélectionnez deux années différentes pour comparer
                      </p>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Bassins Tab */}
            {activeTab === 'bassins' && (
              <div className="space-y-6 animate-fadeIn">
                {/* Bassins Grid */}
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {bassins.map((bassin, idx) => (
                    <div 
                      key={bassin.id} 
                      className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm hover:shadow-xl transition-all duration-300 animate-slideUp"
                      style={{ animationDelay: `${idx * 50}ms` }}
                    >
                      <div className="flex items-start justify-between mb-4">
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-green-400 to-emerald-600 flex items-center justify-center shadow-lg">
                            <MapPin className="w-6 h-6 text-white" />
                          </div>
                          <div>
                            <h3 className="font-bold text-gray-900 dark:text-white">{bassin.nom}</h3>
                            <p className="text-xs text-gray-500 dark:text-gray-400">Code: {bassin.code}</p>
                          </div>
                        </div>
                        {bassin.importance && (
                          <span className={`text-xs px-2 py-1 rounded-full font-semibold ${
                            bassin.importance === 'haute' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                            bassin.importance === 'moyenne' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300' :
                            'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300'
                          }`}>
                            {bassin.importance}
                          </span>
                        )}
                      </div>
                      
                      {bassin.description && (
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-4 line-clamp-2">
                          {bassin.description}
                        </p>
                      )}
                      
                      {bassin.produits_dominants && bassin.produits_dominants.length > 0 && (
                        <div className="mt-4">
                          <p className="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2">Produits dominants:</p>
                          <div className="flex flex-wrap gap-1">
                            {bassin.produits_dominants.slice(0, 3).map((produit: string, i: number) => (
                              <span 
                                key={i}
                                className="text-xs px-2 py-1 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-md border border-green-200 dark:border-green-800"
                              >
                                {produit}
                              </span>
                            ))}
                            {bassin.produits_dominants.length > 3 && (
                              <span className="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 rounded-md">
                                +{bassin.produits_dominants.length - 3}
                              </span>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                {/* Top Products & Regions */}
                <div className="grid lg:grid-cols-2 gap-6">
                  {/* Top Products */}
                  <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm">
                    <div className="flex items-center gap-2 mb-6">
                      <Award className="w-5 h-5 text-green-500" />
                      <h2 className="text-lg font-bold text-gray-900 dark:text-white">Top Produits</h2>
                    </div>
                    <div className="space-y-3">
                      {topProduits.map((produit: any, i: number) => (
                        <div key={i} className="flex items-center gap-3 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg p-4 border border-green-200 dark:border-green-800 hover:scale-105 transition-transform">
                          <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white text-lg shadow-lg ${
                            i === 0 ? 'bg-gradient-to-br from-yellow-400 to-yellow-600' : 
                            i === 1 ? 'bg-gradient-to-br from-gray-300 to-gray-500' : 
                            i === 2 ? 'bg-gradient-to-br from-orange-400 to-orange-600' : 
                            'bg-gradient-to-br from-green-400 to-green-600'
                          }`}>
                            {i + 1}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="font-semibold text-gray-900 dark:text-white truncate">
                              {produit.nom || `Produit ${produit.produit_id}`}
                            </div>
                            <div className="text-xs text-gray-500 dark:text-gray-400">
                              {fmt(produit.total_quantite)} unités • {fmtFCFA(produit.total_valeur_fcfa)}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Top Regions */}
                  <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm">
                    <div className="flex items-center gap-2 mb-6">
                      <Award className="w-5 h-5 text-blue-500" />
                      <h2 className="text-lg font-bold text-gray-900 dark:text-white">Top Régions</h2>
                    </div>
                    <div className="space-y-3">
                      {topRegions.map((region: any, i: number) => (
                        <div key={i} className="flex items-center gap-3 bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800 hover:scale-105 transition-transform">
                          <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white text-lg shadow-lg ${
                            i === 0 ? 'bg-gradient-to-br from-yellow-400 to-yellow-600' : 
                            i === 1 ? 'bg-gradient-to-br from-gray-300 to-gray-500' : 
                            i === 2 ? 'bg-gradient-to-br from-orange-400 to-orange-600' : 
                            'bg-gradient-to-br from-blue-400 to-blue-600'
                          }`}>
                            {i + 1}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="font-semibold text-gray-900 dark:text-white truncate">
                              {region.nom || `Région ${region.region_id}`}
                            </div>
                            <div className="text-xs text-gray-500 dark:text-gray-400">
                              {fmt(region.total_quantite)} unités • {fmtFCFA(region.total_valeur_fcfa)}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\app\layout.tsx
================================================================================

import type { Metadata } from 'next';
import './globals.css';

export const metadata: Metadata = {
  title: 'AgriVision - Cartographie Agricole',
  description: 'Plateforme de cartographie des données agricoles, pastorales et halieutiques du Cameroun',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="fr" suppressHydrationWarning>
      <head>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />
        <link
          href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;500;600;700&display=swap"
          rel="stylesheet"
        />
        <link
          rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossOrigin=""
        />
      </head>
      <body className="font-body antialiased bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 transition-colors duration-300">
        {children}
      </body>
    </html>
  );
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\app\page.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import {
  MapPin,
  TrendingUp,
  Leaf,
  Waves,
  Database,
  ArrowRight,
  BarChart3,
  Globe,
  Sparkles,
} from 'lucide-react';
import ThemeToggle from '@/components/ThemeToggle';
import { getStatistiquesGlobales } from '@/lib/api';
import { SkeletonStat } from '@/components/Skeleton';

export default function HomePage() {
  const [stats, setStats] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [hoveredCard, setHoveredCard] = useState<number | null>(null);

  useEffect(() => {
    loadStats();
  }, []);

  const loadStats = async () => {
    try {
      const data = await getStatistiquesGlobales();
      setStats(data);
    } catch (error) {
      console.error('Erreur lors du chargement des statistiques:', error);
    } finally {
      setLoading(false);
    }
  };

  const features = [
    {
      icon: MapPin,
      title: 'Cartographie Interactive',
      description: 'Explorez les divisions administratives du Cameroun avec une carte interactive et intuitive',
      color: 'from-green-400 to-emerald-600',
    },
    {
      icon: Leaf,
      title: 'Données Agricoles',
      description: 'Accédez aux données de production agricole par région, département et commune',
      color: 'from-lime-400 to-green-600',
    },
    {
      icon: TrendingUp,
      title: 'Statistiques en Temps Réel',
      description: 'Visualisez les tendances et évolutions de la production sur plusieurs années',
      color: 'from-emerald-400 to-teal-600',
    },
    {
      icon: Waves,
      title: 'Zones Halieutiques',
      description: 'Découvrez les zones de pêche maritimes, fluviales et lacustres',
      color: 'from-cyan-400 to-blue-600',
    },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-white via-green-50 to-emerald-50 dark:from-gray-950 dark:via-gray-900 dark:to-gray-950">
      {/* Header */}
      <header className="fixed top-0 left-0 right-0 z-50 backdrop-blur-xl bg-white/80 dark:bg-gray-950/80 border-b border-gray-200 dark:border-gray-800">
        <nav className="max-w-7xl mx-auto px-6 py-4" style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', animation: 'slideRight 0.5s ease-out' }}>
            <div className="w-10 h-10 bg-gradient-to-br from-green-400 to-emerald-600 rounded-xl" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
              <Leaf className="w-6 h-6 text-white" />
            </div>
            <div>
              <h1 className="text-xl font-display font-bold text-gray-900 dark:text-white">
                AgriVision
              </h1>
              <p className="text-xs text-gray-600 dark:text-gray-400">
                Cartographie Agricole
              </p>
            </div>
          </div>
          
          <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
            <ThemeToggle />
            <Link
              href="/map"
              className="px-6 py-2.5 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-xl"
              style={{ display: 'inline-flex', alignItems: 'center', gap: '0.5rem', animation: 'slideLeft 0.5s ease-out' }}
            >
              Accéder à la carte
              <ArrowRight className="w-5 h-5" />
            </Link>
          </div>
        </nav>
      </header>

      {/* Hero Section */}
      <section className="pt-32 pb-20 px-6">
        <div className="max-w-7xl mx-auto">
          <div className="text-center mb-16" style={{ animation: 'slideUp 0.7s ease-out' }}>
            <div className="inline-flex items-center gap-2 px-4 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full mb-6" style={{ animation: 'fadeIn 0.5s ease-in-out' }}>
              <Sparkles className="w-4 h-4" />
              <span className="text-sm font-medium">Plateforme de cartographie interactive</span>
            </div>
            
            <h2 className="text-5xl md:text-6xl font-display font-extrabold text-gray-900 dark:text-white mb-6 leading-tight">
              Explorez les Données
              <br />
              <span className="bg-gradient-to-r from-green-500 to-emerald-600 bg-clip-text text-transparent">
                Agricoles du Cameroun
              </span>
            </h2>
            
            <p className="text-xl text-gray-600 dark:text-gray-400 max-w-3xl mx-auto mb-8">
              Une plateforme moderne pour visualiser et analyser les données de production agricole, 
              pastorale et halieutique à travers les 10 régions du Cameroun.
            </p>

            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '1rem', flexWrap: 'wrap' }}>
              <Link
                href="/map"
                className="px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold rounded-xl transition-all transform hover:scale-105 shadow-2xl hover:shadow-3xl text-lg"
                style={{ display: 'inline-flex', alignItems: 'center', gap: '0.75rem' }}
              >
                <Globe className="w-6 h-6" />
                Découvrir la carte
                <ArrowRight className="w-6 h-6" />
              </Link>
              
              <Link
                href="/stats"
                className="px-8 py-4 bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-900 dark:text-white font-bold rounded-xl border-2 border-gray-200 dark:border-gray-700 transition-all transform hover:scale-105 shadow-lg text-lg"
                style={{ display: 'inline-flex', alignItems: 'center', gap: '0.75rem' }}
              >
                <BarChart3 className="w-6 h-6" />
                Voir les statistiques
              </Link>
            </div>
          </div>

          {/* Stats Cards */}
          {loading ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-20" style={{ animation: 'fadeIn 0.5s ease-in-out' }}>
              {[1, 2, 3, 4].map((i) => (
                <SkeletonStat key={i} />
              ))}
            </div>
          ) : stats && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-20" style={{ animation: 'slideUp 0.8s ease-out' }}>
              {[
                { label: 'Régions', value: stats.total_regions, icon: MapPin, color: 'bg-blue-500' },
                { label: 'Départements', value: stats.total_departements, icon: Database, color: 'bg-purple-500' },
                { label: 'Filières', value: stats.total_filieres, icon: Leaf, color: 'bg-green-500' },
                { label: 'Produits', value: stats.total_produits, icon: TrendingUp, color: 'bg-orange-500' },
              ].map((stat, index) => {
                const Icon = stat.icon;
                return (
                  <div
                    key={index}
                    className="bg-white dark:bg-gray-900 rounded-2xl p-8 border-2 border-gray-200 dark:border-gray-800 hover:border-green-500 dark:hover:border-green-500 transition-all transform hover:scale-105 hover:shadow-2xl cursor-pointer"
                    style={{ animation: `slideUp 0.${8 + index}s ease-out` }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1rem' }}>
                      <div className={`p-3 ${stat.color} rounded-xl`}>
                        <Icon className="w-8 h-8 text-white" />
                      </div>
                      <div className="text-xs font-medium text-gray-500 dark:text-gray-400 px-3 py-1 bg-gray-100 dark:bg-gray-800 rounded-full">
                        Total
                      </div>
                    </div>
                    <div className="text-4xl font-display font-bold text-gray-900 dark:text-white mb-2">
                      {stat.value.toLocaleString()}
                    </div>
                    <div className="text-sm font-medium text-gray-600 dark:text-gray-400">
                      {stat.label}
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* Features Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            {features.map((feature, index) => {
              const Icon = feature.icon;
              return (
                <div
                  key={index}
                  onMouseEnter={() => setHoveredCard(index)}
                  onMouseLeave={() => setHoveredCard(null)}
                  className="group relative bg-white dark:bg-gray-900 rounded-2xl p-8 border-2 border-gray-200 dark:border-gray-800 hover:border-green-500 dark:hover:border-green-500 transition-all transform hover:scale-105 hover:shadow-2xl cursor-pointer overflow-hidden"
                  style={{ animation: `slideUp ${1 + index * 0.1}s ease-out` }}
                >
                  {/* Gradient Background on Hover */}
                  <div
                    className={`absolute inset-0 bg-gradient-to-br ${feature.color} opacity-0 group-hover:opacity-10 dark:group-hover:opacity-20 transition-opacity duration-300`}
                  />
                  
                  <div className="relative z-10">
                    <div className={`inline-flex p-4 bg-gradient-to-br ${feature.color} rounded-2xl mb-6 transform transition-transform duration-300 ${hoveredCard === index ? 'scale-110 rotate-3' : ''}`}>
                      <Icon className="w-8 h-8 text-white" />
                    </div>
                    
                    <h3 className="text-2xl font-display font-bold text-gray-900 dark:text-white mb-3">
                      {feature.title}
                    </h3>
                    
                    <p className="text-gray-600 dark:text-gray-400 leading-relaxed">
                      {feature.description}
                    </p>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </section>

      {/* CTA Section */}
      <section className="py-20 px-6 bg-gradient-to-r from-green-500 to-emerald-600">
        <div className="max-w-4xl mx-auto text-center" style={{ animation: 'slideUp 1.2s ease-out' }}>
          <h2 className="text-4xl md:text-5xl font-display font-extrabold text-white mb-6">
            Prêt à explorer les données ?
          </h2>
          <p className="text-xl text-green-50 mb-8">
            Accédez à la carte interactive et découvrez les bassins de production du Cameroun
          </p>
          <Link
            href="/map"
            className="inline-flex items-center gap-3 px-10 py-5 bg-white text-green-600 font-bold rounded-xl text-lg transition-all transform hover:scale-105 shadow-2xl hover:shadow-3xl"
          >
            <Globe className="w-7 h-7" />
            Commencer l'exploration
            <ArrowRight className="w-7 h-7" />
          </Link>
        </div>
      </section>

      {/* Footer */}
      <footer className="py-12 px-6 bg-white dark:bg-gray-950 border-t border-gray-200 dark:border-gray-800">
        <div className="max-w-7xl mx-auto text-center">
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.75rem', marginBottom: '1rem' }}>
            <div className="w-8 h-8 bg-gradient-to-br from-green-400 to-emerald-600 rounded-lg" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
              <Leaf className="w-5 h-5 text-white" />
            </div>
            <span className="text-lg font-display font-bold text-gray-900 dark:text-white">
              AgriVision
            </span>
          </div>
          <p className="text-sm text-gray-600 dark:text-gray-400">
            © 2025 AgriVision. Plateforme de cartographie agricole du Cameroun.
          </p>
        </div>
      </footer>
    </div>
  );
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\app\globals.css
================================================================================

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --color-primary: 34 197 94;
  }

  body {
    font-family: 'Open Sans', system-ui, sans-serif;
  }

  h1, h2, h3, h4, h5, h6 {
    font-family: 'Montserrat', system-ui, sans-serif;
  }
}

@layer utilities {
  .text-balance {
    text-wrap: balance;
  }

  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .scrollbar-thin::-webkit-scrollbar-track {
    @apply bg-gray-100 dark:bg-gray-900;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    @apply bg-gray-300 dark:bg-gray-700 rounded-full;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    @apply bg-gray-400 dark:bg-gray-600;
  }
}

/* ─── Shimmer ──────────────────────────────────────────────────────────────── */
@keyframes shimmer {
  0% { background-position: -1000px 0; }
  100% { background-position: 1000px 0; }
}

.animate-shimmer {
  animation: shimmer 2s infinite linear;
  background: linear-gradient(
    to right,
    rgba(229, 231, 235, 0.1) 0%,
    rgba(229, 231, 235, 0.3) 50%,
    rgba(229, 231, 235, 0.1) 100%
  );
  background-size: 2000px 100%;
}

.dark .animate-shimmer {
  background: linear-gradient(
    to right,
    rgba(31, 41, 55, 0.1) 0%,
    rgba(31, 41, 55, 0.3) 50%,
    rgba(31, 41, 55, 0.1) 100%
  );
  background-size: 2000px 100%;
}

/* ─── Page-level entrance animations ───────────────────────────────────────── */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(18px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(-18px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}
@keyframes slideRight {
  from { opacity: 0; transform: translateX(-24px); }
  to   { opacity: 1; transform: translateX(0); }
}
@keyframes slideLeft {
  from { opacity: 0; transform: translateX(24px); }
  to   { opacity: 1; transform: translateX(0); }
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(24px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes slideDown {
  from { opacity: 0; transform: translateY(-24px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes scaleIn {
  from { opacity: 0; transform: scale(0.88); }
  to   { opacity: 1; transform: scale(1); }
}
@keyframes pulseGreen {
  0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.5); }
  50%      { box-shadow: 0 0 0 8px rgba(34,197,94,0); }
}
@keyframes spinSlow {
  to { transform: rotate(360deg); }
}
/* counter animation */
@keyframes countUp {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

.animate-fadeInUp   { animation: fadeInUp   0.55s cubic-bezier(.22,.61,0,1) both; }
.animate-fadeInDown { animation: fadeInDown 0.55s cubic-bezier(.22,.61,0,1) both; }
.animate-fadeIn     { animation: fadeIn     0.45s ease both; }
.animate-slideUp    { animation: slideUp    0.55s cubic-bezier(.22,.61,0,1) both; }
.animate-slideDown  { animation: slideDown  0.55s cubic-bezier(.22,.61,0,1) both; }
.animate-slideRight { animation: slideRight 0.5s  cubic-bezier(.22,.61,0,1) both; }
.animate-slideLeft  { animation: slideLeft  0.5s  cubic-bezier(.22,.61,0,1) both; }
.animate-scaleIn    { animation: scaleIn    0.4s  cubic-bezier(.22,.61,0,1) both; }
.animate-pulseGreen { animation: pulseGreen 2s    ease-in-out infinite; }
.animate-countUp    { animation: countUp    0.5s  cubic-bezier(.22,.61,0,1) both; }

/* staggered delay helpers */
.delay-50  { animation-delay: 50ms; }
.delay-100 { animation-delay: 100ms; }
.delay-150 { animation-delay: 150ms; }
.delay-200 { animation-delay: 200ms; }
.delay-250 { animation-delay: 250ms; }
.delay-300 { animation-delay: 300ms; }
.delay-350 { animation-delay: 350ms; }
.delay-400 { animation-delay: 400ms; }
.delay-500 { animation-delay: 500ms; }
.delay-600 { animation-delay: 600ms; }

/* ─── Leaflet dark-mode ────────────────────────────────────────────────────── */
.dark .leaflet-container {
  background: #1a1a1a;
}
.dark .leaflet-tile {
  filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
}

/* ─── Card glass effect ────────────────────────────────────────────────────── */
.glass-card {
  background: rgba(255,255,255,0.72);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border: 1px solid rgba(255,255,255,0.5);
}
.dark .glass-card {
  background: rgba(20,24,34,0.72);
  border-color: rgba(255,255,255,0.08);
}

/* ─── Gradient text helper ─────────────────────────────────────────────────── */
.gradient-text-green {
  background: linear-gradient(135deg, #22c55e, #10b981, #14b8a6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* ─── Tooltip & map overrides ──────────────────────────────────────────────── */
.map-tooltip {
  background: rgba(255,255,255,0.95) !important;
  border: 2px solid #22c55e !important;
  border-radius: 8px !important;
  padding: 6px 10px !important;
  font-weight: 600 !important;
  font-size: 13px !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
  backdrop-filter: blur(4px) !important;
  pointer-events: none !important;
}
.dark .map-tooltip {
  background: rgba(31,41,55,0.95) !important;
  border-color: #16a34a !important;
  color: white !important;
}
.leaflet-control-attribution {
  font-size: 10px !important;
  background: rgba(255,255,255,0.7) !important;
  padding: 2px 5px !important;
}
.dark .leaflet-control-attribution {
  background: rgba(0,0,0,0.5) !important;
  color: rgba(255,255,255,0.7) !important;
}

/* ─── Recharts responsive fix ──────────────────────────────────────────────── */
.recharts-wrapper { width: 100% !important; }


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\app\error.tsx
================================================================================

'use client';

import { useEffect } from 'react';
import { AlertCircle, RefreshCw } from 'lucide-react';

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    console.error('Application Error:', error);
  }, [error]);

  return (
    <div className="min-h-screen bg-white dark:bg-gray-950 flex items-center justify-center p-6">
      <div className="max-w-md w-full text-center">
        <div className="inline-flex items-center justify-center w-20 h-20 bg-red-100 dark:bg-red-900/30 rounded-full mb-6">
          <AlertCircle className="w-10 h-10 text-red-600 dark:text-red-400" />
        </div>
        
        <h2 className="text-3xl font-display font-bold text-gray-900 dark:text-white mb-4">
          Une erreur est survenue
        </h2>
        
        <p className="text-gray-600 dark:text-gray-400 mb-8">
          {error.message || 'Désolé, quelque chose s\'est mal passé. Veuillez réessayer.'}
        </p>
        
        <button
          onClick={reset}
          className="inline-flex items-center gap-2 px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-all transform hover:scale-105"
        >
          <RefreshCw className="w-5 h-5" />
          Réessayer
        </button>
      </div>
    </div>
  );
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\app\not-found.tsx
================================================================================

'use client';

import Link from 'next/link';
import { Home, MapPin } from 'lucide-react';

export default function NotFound() {
  return (
    <div className="min-h-screen bg-gradient-to-br from-white via-green-50 to-emerald-50 dark:from-gray-950 dark:via-gray-900 dark:to-gray-950 flex items-center justify-center p-6">
      <div className="max-w-md w-full text-center">
        <div className="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full mb-6">
          <MapPin className="w-12 h-12 text-white" />
        </div>
        
        <h1 className="text-9xl font-display font-extrabold text-gray-900 dark:text-white mb-4">
          404
        </h1>
        
        <h2 className="text-3xl font-display font-bold text-gray-900 dark:text-white mb-4">
          Page non trouvée
        </h2>
        
        <p className="text-gray-600 dark:text-gray-400 mb-8">
          Désolé, la page que vous recherchez n'existe pas ou a été déplacée.
        </p>
        
        <Link
          href="/"
          className="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium rounded-lg transition-all transform hover:scale-105 shadow-lg"
        >
          <Home className="w-5 h-5" />
          Retour à l'accueil
        </Link>
      </div>
    </div>
  );
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\components\MapView.tsx
================================================================================

'use client';

import { useEffect, useRef, useState, memo } from 'react';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import type { GeoJSONFeatureCollection, MapLevel } from '@/types/api';

const MAPTILER_API_KEY = "Lr72DkH8TYyjpP7RNZS9";

interface MapViewProps {
  geoData: GeoJSONFeatureCollection | null;
  loading: boolean;
  mapLevel: MapLevel;
  onFeatureClick?: (properties: any) => void;
  selectedFeatureId?: number | null;
}

const MapSkeleton = () => (
  <div className="w-full h-full bg-gray-100 dark:bg-gray-900 flex items-center justify-center rounded-xl">
    <div className="text-center">
      <div className="inline-block w-14 h-14 border-4 border-green-500 border-t-transparent rounded-full animate-spin mb-3" />
      <p className="text-gray-500 dark:text-gray-400 text-sm font-medium">Chargement…</p>
    </div>
  </div>
);

export default memo(function MapView({
  geoData,
  loading,
  mapLevel,
  onFeatureClick,
  selectedFeatureId,
}: MapViewProps) {
  const mapRef = useRef<L.Map | null>(null);
  const geoJsonLayerRef = useRef<L.GeoJSON | null>(null);
  const mapContainerRef = useRef<HTMLDivElement>(null);
  const [mapReady, setMapReady] = useState(false);
  const onFeatureClickRef = useRef(onFeatureClick);
  const currentGeoDataRef = useRef<GeoJSONFeatureCollection | null>(null);
  const layersByIdRef = useRef<Map<number, L.Layer>>(new Map());
  const isCleaningUpRef = useRef(false);

  useEffect(() => {
    onFeatureClickRef.current = onFeatureClick;
  }, [onFeatureClick]);

  // ── Initialisation carte (une seule fois) ────────────────────────────────
  useEffect(() => {
    if (!mapContainerRef.current || mapRef.current || isCleaningUpRef.current) return;

    console.log('%c🗺️  [MapView] Initializing map...', 'color: #22c55e; font-weight: bold');
    
    try {
      const map = L.map(mapContainerRef.current, {
        center: [7.3697, 12.3547],
        zoom: 6,
        zoomControl: false,
        preferCanvas: true,
        fadeAnimation: false,
        zoomAnimation: true,
        markerZoomAnimation: false,
        attributionControl: false,
      });

      L.control.zoom({ position: 'topright' }).addTo(map);

      L.control.attribution({
        position: 'bottomright',
        prefix: false,
      }).addAttribution(
        '<a href="https://www.maptiler.com/copyright/" target="_blank">© MapTiler</a> ' +
        '<a href="https://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap</a>'
      ).addTo(map);

      // MapTiler Streets
      L.tileLayer(
        `https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${MAPTILER_API_KEY}`,
        {
          tileSize: 512,
          zoomOffset: -1,
          minZoom: 1,
          maxZoom: 19,
          crossOrigin: true,
          updateWhenIdle: true,
          updateWhenZooming: false,
          keepBuffer: 4,
        }
      ).addTo(map);

      mapRef.current = map;
      setMapReady(true);
      console.log('%c✅ Map initialized', 'color: #22c55e; font-weight: bold');
    } catch (error) {
      console.error('%c❌ Map init failed:', 'color: #ef4444; font-weight: bold', error);
    }

    return () => {
      console.log('%c🗑️  Cleaning up map', 'color: #f59e0b');
      isCleaningUpRef.current = true;
      
      if (geoJsonLayerRef.current && mapRef.current) {
        try {
          mapRef.current.removeLayer(geoJsonLayerRef.current);
          geoJsonLayerRef.current = null;
        } catch (e) {
          console.warn('Error removing GeoJSON layer:', e);
        }
      }
      
      if (mapRef.current) {
        try {
          mapRef.current.off();
          mapRef.current.remove();
          mapRef.current = null;
        } catch (e) {
          console.warn('Error removing map:', e);
        }
      }
      
      layersByIdRef.current.clear();
      setMapReady(false);
      isCleaningUpRef.current = false;
    };
  }, []);

  // ── Mise à jour GeoJSON OPTIMISÉE (incrémentale si possible) ──────────────
  useEffect(() => {
    if (!mapRef.current || !mapReady || !geoData || isCleaningUpRef.current) return;

    const startTime = performance.now();
    
    // Vérifier si on peut faire une mise à jour incrémentale
    const canIncrementalUpdate = 
      currentGeoDataRef.current &&
      currentGeoDataRef.current.features.length === geoData.features.length &&
      geoJsonLayerRef.current;

    if (canIncrementalUpdate) {
      console.log('%c⚡ Incremental style update', 'color: #10b981; font-weight: bold');
      
      // Mise à jour incrémentale des styles uniquement
      geoData.features.forEach((feature) => {
        const id = feature.properties?.id;
        if (!id) return;
        
        const layer = layersByIdRef.current.get(id);
        if (layer && layer instanceof L.Path) {
          try {
            const isSelected = id === selectedFeatureId;
            const baseColor = getFeatureColor(feature);
            
            layer.setStyle({
              fillColor: isSelected ? '#22c55e' : baseColor,
              weight: isSelected ? 3 : 1.5,
              opacity: 1,
              color: isSelected ? '#15803d' : '#16a34a',
              fillOpacity: isSelected ? 0.85 : 0.65,
            });
          } catch (e) {
            console.warn('Error updating layer style:', e);
          }
        }
      });
      
      currentGeoDataRef.current = geoData;
      const elapsed = (performance.now() - startTime).toFixed(1);
      console.log(`%c✅ Styles updated in ${elapsed}ms`, 'color: #22c55e; font-weight: bold');
      return;
    }

    // Sinon, re-créer la couche complète
    console.log(`%c🔄 Full GeoJSON update - ${geoData.features.length} features`, 'color: #3b82f6; font-weight: bold');

    if (geoJsonLayerRef.current && mapRef.current) {
      try {
        mapRef.current.removeLayer(geoJsonLayerRef.current);
        geoJsonLayerRef.current = null;
      } catch (e) {
        console.warn('Error removing old GeoJSON layer:', e);
      }
    }
    
    layersByIdRef.current.clear();

    try {
      const geoJsonLayer = L.geoJSON(geoData, {
        style: (feature) => {
          const isSelected = feature?.properties?.id === selectedFeatureId;
          const baseColor = getFeatureColor(feature);

          return {
            fillColor: isSelected ? '#22c55e' : baseColor,
            weight: isSelected ? 3 : 1.5,
            opacity: 1,
            color: isSelected ? '#15803d' : '#16a34a',
            fillOpacity: isSelected ? 0.85 : 0.65,
          };
        },
        onEachFeature: (feature, layer) => {
          const props = feature.properties;
          if (!props) return;

          // Sauvegarder la référence au layer
          if (props.id) {
            layersByIdRef.current.set(props.id, layer);
          }

          const name = props.nom || props.name || 'Sans nom';

          // Tooltip
          const tooltipContent = `
            <div class="font-semibold text-base">${name}</div>
            ${props.population ? `<div class="text-xs mt-1">👥 ${new Intl.NumberFormat('fr-FR').format(props.population)} hab.</div>` : ''}
            ${props.superficie_km2 ? `<div class="text-xs">📏 ${new Intl.NumberFormat('fr-FR').format(props.superficie_km2)} km²</div>` : ''}
            ${props.production_count ? `<div class="text-xs">🌾 ${props.production_count} production(s)</div>` : ''}
            ${props.production_total ? `<div class="text-xs">📊 ${new Intl.NumberFormat('fr-FR').format(props.production_total)} unités</div>` : ''}
          `;

          layer.bindTooltip(tooltipContent, {
            permanent: false,
            direction: 'center',
            className: 'map-tooltip',
            opacity: 0.95,
          });

          // Click handler
          layer.on('click', () => {
            if (!isCleaningUpRef.current) {
              console.log('%c🖱️  Feature clicked:', 'color: #8b5cf6', props);
              if (onFeatureClickRef.current) {
                onFeatureClickRef.current(props);
              }
            }
          });

          // Hover effects
          layer.on('mouseover', function (this: any) {
            if (!isCleaningUpRef.current && this.setStyle) {
              this.setStyle({ fillOpacity: 0.9, weight: 2.5 });
            }
          });
          
          layer.on('mouseout', function (this: any) {
            if (!isCleaningUpRef.current && this.setStyle) {
              const isSelected = props.id === selectedFeatureId;
              this.setStyle({
                fillOpacity: isSelected ? 0.85 : 0.65,
                weight: isSelected ? 3 : 1.5,
              });
            }
          });
        },
      });

      if (mapRef.current && !isCleaningUpRef.current) {
        geoJsonLayer.addTo(mapRef.current);
        geoJsonLayerRef.current = geoJsonLayer;
        currentGeoDataRef.current = geoData;

        // Ajuster la vue
        try {
          const bounds = geoJsonLayer.getBounds();
          if (bounds.isValid()) {
            mapRef.current.fitBounds(bounds, {
              padding: [50, 50],
              animate: true,
              duration: 0.4,
            });
          }
        } catch (error) {
          console.error('%c❌ Bounds error:', 'color: #ef4444', error);
        }
      }

      const elapsed = (performance.now() - startTime).toFixed(1);
      console.log(`%c✅ GeoJSON rendered in ${elapsed}ms`, 'color: #22c55e; font-weight: bold');
    } catch (error) {
      console.error('%c❌ GeoJSON render error:', 'color: #ef4444', error);
    }
  }, [geoData, mapReady, selectedFeatureId, mapLevel]);

  // ── Zoom sur sélection ────────────────────────────────────────────────────
  useEffect(() => {
    if (!mapRef.current || !selectedFeatureId || isCleaningUpRef.current) return;

    const layer = layersByIdRef.current.get(selectedFeatureId);
    if (layer && 'getBounds' in layer) {
      try {
        const bounds = (layer as any).getBounds();
        if (bounds && bounds.isValid()) {
          mapRef.current.fitBounds(bounds, {
            padding: [100, 100],
            maxZoom: 12,
            animate: true,
            duration: 0.6,
          });
        }
      } catch (e) {
        console.error('Zoom error:', e);
      }
    }
  }, [selectedFeatureId]);

  return (
    <div className="relative w-full h-full">
      <div
        ref={mapContainerRef}
        className="w-full h-full rounded-xl overflow-hidden border-2 border-gray-200 dark:border-gray-800 shadow-2xl"
      />

      {!geoData && !loading && mapReady && (
        <div className="absolute inset-0 flex items-center justify-center bg-gray-100/80 dark:bg-gray-900/80 rounded-xl backdrop-blur-sm pointer-events-none">
          <div className="text-center p-8">
            <svg className="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
            <p className="text-gray-600 dark:text-gray-400 text-lg font-medium">
              Sélectionnez des filtres pour afficher les données
            </p>
          </div>
        </div>
      )}

      <style jsx global>{`
        .leaflet-container {
          font-family: inherit;
          background: #f3f4f6;
        }
        
        .dark .leaflet-container {
          background: #111827;
        }
        
        .map-tooltip {
          background: rgba(255, 255, 255, 0.98) !important;
          border: 2px solid #22c55e !important;
          border-radius: 10px !important;
          padding: 8px 12px !important;
          font-weight: 600 !important;
          font-size: 13px !important;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
          backdrop-filter: blur(8px) !important;
          pointer-events: none !important;
          line-height: 1.4 !important;
        }
        
        .dark .map-tooltip {
          background: rgba(31, 41, 55, 0.98) !important;
          border-color: #16a34a !important;
          color: white !important;
        }
        
        .leaflet-control-attribution {
          font-size: 9px !important;
          background: rgba(255, 255, 255, 0.8) !important;
          padding: 2px 6px !important;
          border-radius: 4px !important;
        }
        
        .dark .leaflet-control-attribution {
          background: rgba(0, 0, 0, 0.6) !important;
          color: rgba(255, 255, 255, 0.8) !important;
        }
        
        .leaflet-control-attribution a {
          color: #22c55e !important;
          text-decoration: none !important;
        }
        
        .dark .leaflet-control-attribution a {
          color: #86efac !important;
        }
        
        .leaflet-tile {
          will-change: opacity;
        }
        
        .leaflet-zoom-anim .leaflet-zoom-animated {
          will-change: transform;
        }
        
        .leaflet-control-zoom {
          border: none !important;
          border-radius: 8px !important;
          overflow: hidden !important;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        }
        
        .leaflet-control-zoom a {
          width: 36px !important;
          height: 36px !important;
          line-height: 36px !important;
          font-size: 18px !important;
          background: white !important;
          color: #374151 !important;
          border: none !important;
        }
        
        .dark .leaflet-control-zoom a {
          background: #1f2937 !important;
          color: #e5e7eb !important;
        }
        
        .leaflet-control-zoom a:hover {
          background: #f3f4f6 !important;
          color: #22c55e !important;
        }
        
        .dark .leaflet-control-zoom a:hover {
          background: #374151 !important;
          color: #86efac !important;
        }
      `}</style>
    </div>
  );
});

// Helper: Déterminer la couleur d'une feature
function getFeatureColor(feature: any): string {
  const filiereColors: Record<string, string> = {
    'agriculture': '#22c55e',
    'élevage': '#f59e0b',
    'pêche': '#3b82f6',
    'foresterie': '#10b981',
  };

  const filiere = feature?.properties?.filiere_principale?.toLowerCase();
  if (filiere && filiereColors[filiere]) {
    return filiereColors[filiere];
  }

  // Couleur basée sur la production
  const prodTotal = feature?.properties?.production_total;
  if (prodTotal && prodTotal > 0) {
    // Gradient vert en fonction de la production
    if (prodTotal > 10000) return '#15803d';
    if (prodTotal > 5000) return '#16a34a';
    if (prodTotal > 1000) return '#22c55e';
    return '#4ade80';
  }

  return '#86efac'; // Couleur par défaut
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\components\Sidebar.tsx
================================================================================

'use client';

import { useState, useEffect, useRef } from 'react';
import Link from 'next/link';
import {
  Search, Filter, MapPin, Layers, TrendingUp, X,
  ChevronDown, ChevronRight, Wheat, Package, Calendar,
  ExternalLink, Info,
} from 'lucide-react';
import type { Filiere, CategorieProduit, Produit, MapLevel } from '@/types/api';
import {
  getFilieres, getCategories, getProduits,
  searchFilieres, getAnneesDisponibles,
} from '@/lib/api';
import { SkeletonList } from './Skeleton';

interface SidebarProps {
  onFilterChange   : (filters: any) => void;
  onMapLevelChange : (level: MapLevel) => void;
  selectedEntity   : any;
  currentMapLevel  : MapLevel;
}

export default function Sidebar({
  onFilterChange,
  onMapLevelChange,
  selectedEntity,
  currentMapLevel,
}: SidebarProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [activeTab, setActiveTab]     = useState<'filters' | 'info'>('filters');

  const [filieres,   setFilieres]   = useState<Filiere[]>([]);
  const [categories, setCategories] = useState<CategorieProduit[]>([]);
  const [produits,   setProduits]   = useState<Produit[]>([]);
  const [annees,     setAnnees]     = useState<number[]>([]);

  const [selectedFiliere,   setSelectedFiliere]   = useState<number | null>(null);
  const [selectedCategorie, setSelectedCategorie] = useState<number | null>(null);
  const [selectedProduit,   setSelectedProduit]   = useState<number | null>(null);
  const [selectedAnnee,     setSelectedAnnee]     = useState<number | null>(null);

  const [openSections, setOpenSections] = useState({
    filieres: true, categories: false, produits: false,
    mapLevel: true, annee: false,
  });

  const [loading, setLoading] = useState(false);

  const prevFiltersRef     = useRef({ filiere_id: null as number|null, categorie_id: null as number|null, produit_id: null as number|null, annee: null as number|null });
  const onFilterChangeRef  = useRef(onFilterChange);
  useEffect(() => { onFilterChangeRef.current = onFilterChange; }, [onFilterChange]);

  // ── Initial load ─────────────────────────────────────────────────────────
  useEffect(() => { loadFilieres(); loadAnnees(); }, []);

  // Modifiez la condition et l'appel pour être plus précis
  useEffect(() => {
    if (selectedFiliere !== null) {
      loadCategories(selectedFiliere);
      setOpenSections(p => ({ ...p, categories: true }));
    } else {
      setCategories([]);
      setSelectedCategorie(null);
    }
  }, [selectedFiliere]);

  // ── Cascade: catégorie / filière → produits ──────────────────────────────
  useEffect(() => {
    if (selectedCategorie !== null) {
      // On convertit le null potentiel en undefined pour satisfaire le type du paramètre optionnel
      loadProduits(selectedCategorie, selectedFiliere ?? undefined);
      setOpenSections(p => ({ ...p, produits: true }));
    } else if (selectedFiliere !== null) {
      loadProduits(undefined, selectedFiliere ?? undefined);
    } else {
      setProduits([]);
      setSelectedProduit(null);
    }
  }, [selectedCategorie, selectedFiliere]);

  // ── Notify parent only on real change ────────────────────────────────────
  useEffect(() => {
    const nf = { filiere_id: selectedFiliere, categorie_id: selectedCategorie, produit_id: selectedProduit, annee: selectedAnnee };
    const pv = prevFiltersRef.current;
    if (pv.filiere_id !== nf.filiere_id || pv.categorie_id !== nf.categorie_id || pv.produit_id !== nf.produit_id || pv.annee !== nf.annee) {
      prevFiltersRef.current = nf;
      onFilterChangeRef.current(nf);
    }
  }, [selectedFiliere, selectedCategorie, selectedProduit, selectedAnnee]);

  // ── When entity selected → auto-switch to info tab ───────────────────────
  useEffect(() => {
    if (selectedEntity) setActiveTab('info');
  }, [selectedEntity]);

  // ── Loaders ──────────────────────────────────────────────────────────────
  const loadFilieres = async () => {
    try { setLoading(true); const r = await getFilieres(0, 100); setFilieres(r.items); }
    catch (e) { console.error('loadFilieres', e); }
    finally { setLoading(false); }
  };
  const loadCategories = async (fId: number) => {
    try { const r = await getCategories(0, 100, fId); setCategories(r.items); }
    catch (e) { console.error('loadCategories', e); }
  };
  const loadProduits = async (cId?: number, fId?: number) => {
    try { const r = await getProduits(0, 100, cId, fId); setProduits(r.items); }
    catch (e) { console.error('loadProduits', e); }
  };
  const loadAnnees = async () => {
    try { const d = await getAnneesDisponibles(); setAnnees(d); }
    catch (e) { console.error('loadAnnees', e); }
  };

  const handleSearch = async () => {
    if (searchQuery.trim().length < 2) return;
    try { setLoading(true); setFilieres(await searchFilieres(searchQuery, 10)); }
    catch (e) { console.error('handleSearch', e); }
    finally { setLoading(false); }
  };

  const toggleSection = (s: keyof typeof openSections) =>
    setOpenSections(p => ({ ...p, [s]: !p[s] }));

  const resetFilters = () => {
    setSelectedFiliere(null); setSelectedCategorie(null);
    setSelectedProduit(null); setSelectedAnnee(null);
    setSearchQuery('');
    loadFilieres();
  };

  const mapLevelOptions: { value: MapLevel; label: string; icon: typeof MapPin }[] = [
    { value: 'regions',      label: 'Régions',      icon: MapPin },
    { value: 'departements', label: 'Départements', icon: Layers },
    { value: 'communes',     label: 'Communes',     icon: TrendingUp },
  ];

  // ── Detail URL helper ────────────────────────────────────────────────────
  const detailUrl = selectedEntity
    ? `/map/${selectedEntity.id}?level=${currentMapLevel}`
    : '#';

  // ── Shared button style ──────────────────────────────────────────────────
  const btnBase = (active: boolean) =>
    `w-full px-4 py-2.5 rounded-lg text-left transition-all duration-200 border-2 ${
      active
        ? 'bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 border-green-500 font-semibold'
        : 'bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-transparent hover:border-green-300 dark:hover:border-green-700 hover:bg-green-50/50 dark:hover:bg-green-900/20'
    }`;

  return (
    <div className="h-full flex flex-col bg-white dark:bg-gray-950 border-r border-gray-200 dark:border-gray-800">
      {/* Header */}
      <div className="p-5 border-b border-gray-200 dark:border-gray-800 bg-gradient-to-r from-green-50 to-white dark:from-gray-900 dark:to-gray-950">
        <h2 className="text-lg font-display font-bold text-gray-900 dark:text-white">Filtres &amp; Recherche</h2>
        <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Données agricoles du Cameroun</p>
      </div>

      {/* Tabs */}
      <div className="flex border-b border-gray-200 dark:border-gray-800">
        {(['filters', 'info'] as const).map(tab => (
          <button
            key={tab}
            onClick={() => setActiveTab(tab)}
            className={`flex-1 py-2.5 text-sm font-medium transition-all flex items-center justify-center gap-1.5 ${
              activeTab === tab
                ? 'border-b-2 border-green-500 text-green-600 dark:text-green-400 bg-green-50/60 dark:bg-green-900/20'
                : 'text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200'
            }`}
          >
            {tab === 'filters' ? <Filter className="w-4 h-4" /> : <Info className="w-4 h-4" />}
            {tab === 'filters' ? 'Filtres' : 'Informations'}
          </button>
        ))}
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-4">
        {activeTab === 'filters' ? (
          <>
            {/* Search */}
            <div>
              <label className="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1.5 flex items-center gap-1.5">
                <Search className="w-3.5 h-3.5" /> Recherche rapide
              </label>
              <div className="relative">
                <input
                  type="text"
                  value={searchQuery}
                  onChange={e => setSearchQuery(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && handleSearch()}
                  placeholder="Filière, produit…"
                  className="w-full px-3 py-2 pr-9 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all"
                />
                <button onClick={handleSearch} className="absolute right-2 top-1/2 -translate-y-1/2 text-green-600 dark:text-green-400 hover:opacity-70 transition-opacity">
                  <Search className="w-4 h-4" />
                </button>
              </div>
            </div>

            {/* Niveau de visualisation */}
            <div>
              <button onClick={() => toggleSection('mapLevel')} className="w-full flex items-center justify-between text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1.5">
                <span className="flex items-center gap-1.5"><Layers className="w-3.5 h-3.5" /> Niveau</span>
                {openSections.mapLevel ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
              </button>
              {openSections.mapLevel && (
                <div className="flex gap-2">
                  {mapLevelOptions.map(opt => {
                    const Icon = opt.icon;
                    const active = currentMapLevel === opt.value;
                    return (
                      <button key={opt.value} onClick={() => onMapLevelChange(opt.value)}
                        className={`flex-1 py-2 rounded-lg text-center text-xs font-semibold transition-all border-2 flex flex-col items-center gap-0.5 ${
                          active
                            ? 'bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 border-green-500'
                            : 'bg-gray-50 dark:bg-gray-800 text-gray-500 dark:text-gray-400 border-transparent hover:border-green-300'
                        }`}>
                        <Icon className="w-4 h-4" />
                        {opt.label}
                      </button>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Filières */}
            <div>
              <button onClick={() => toggleSection('filieres')} className="w-full flex items-center justify-between text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1.5">
                <span className="flex items-center gap-1.5"><Wheat className="w-3.5 h-3.5" /> Filières <span className="text-green-600 dark:text-green-400">({filieres.length})</span></span>
                {openSections.filieres ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
              </button>
              {openSections.filieres && (
                <div className="space-y-1.5">
                  {loading ? <SkeletonList count={3} /> : filieres.map(f => (
                    <button key={f.id} onClick={() => setSelectedFiliere(f.id === selectedFiliere ? null : f.id)} className={btnBase(selectedFiliere === f.id)}>
                      <div className="flex items-center gap-2.5">
                        <div className="w-3 h-3 rounded-full flex-shrink-0" style={{ backgroundColor: f.couleur || '#22c55e' }} />
                        <div className="min-w-0">
                          <div className="font-medium truncate text-sm">{f.nom}</div>
                          {f.description && <div className="text-xs text-gray-400 dark:text-gray-500 truncate">{f.description}</div>}
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Catégories */}
            {selectedFiliere && categories.length > 0 && (
              <div>
                <button onClick={() => toggleSection('categories')} className="w-full flex items-center justify-between text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1.5">
                  <span className="flex items-center gap-1.5"><Package className="w-3.5 h-3.5" /> Catégories <span className="text-green-600 dark:text-green-400">({categories.length})</span></span>
                  {openSections.categories ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
                </button>
                {openSections.categories && (
                  <div className="space-y-1.5 pl-4 border-l-2 border-green-200 dark:border-green-800 ml-1.5">
                    {categories.map(c => (
                      <button key={c.id} onClick={() => setSelectedCategorie(c.id === selectedCategorie ? null : c.id)} className={btnBase(selectedCategorie === c.id)}>
                        <span className="text-sm">{c.nom}</span>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Produits */}
            {produits.length > 0 && (
              <div>
                <button onClick={() => toggleSection('produits')} className="w-full flex items-center justify-between text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1.5">
                  <span className="flex items-center gap-1.5"><Package className="w-3.5 h-3.5" /> Produits <span className="text-green-600 dark:text-green-400">({produits.length})</span></span>
                  {openSections.produits ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
                </button>
                {openSections.produits && (
                  <div className="space-y-1.5 pl-4 border-l-2 border-green-100 dark:border-green-900 ml-1.5">
                    {produits.slice(0, 12).map(p => (
                      <button key={p.id} onClick={() => setSelectedProduit(p.id === selectedProduit ? null : p.id)} className={btnBase(selectedProduit === p.id)}>
                        <div className="text-sm font-medium">{p.nom}</div>
                        {p.unite_mesure && <div className="text-xs text-gray-400 dark:text-gray-500">Unité : {p.unite_mesure}</div>}
                      </button>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Année */}
            <div>
              <button onClick={() => toggleSection('annee')} className="w-full flex items-center justify-between text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1.5">
                <span className="flex items-center gap-1.5"><Calendar className="w-3.5 h-3.5" /> Année</span>
                {openSections.annee ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
              </button>
              {openSections.annee && annees.length > 0 && (
                <select value={selectedAnnee || ''} onChange={e => setSelectedAnnee(e.target.value ? Number(e.target.value) : null)}
                  className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
                  <option value="">Toutes les années</option>
                  {annees.map(a => <option key={a} value={a}>{a}</option>)}
                </select>
              )}
            </div>

            {/* Reset */}
            <button onClick={resetFilters} className="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-1.5">
              <X className="w-4 h-4" /> Réinitialiser
            </button>
          </>
        ) : (
          /* ── Info tab ─────────────────────────────────────────────────────── */
          <div className="space-y-3">
            {selectedEntity ? (
              <>
                {/* Entity card */}
                <div className="anim-slideUp bg-gradient-to-br from-green-50 to-white dark:from-gray-900 dark:to-gray-950 rounded-xl p-5 border-2 border-green-200 dark:border-green-800">
                  <div className="flex items-start justify-between mb-3">
                    <h3 className="text-base font-display font-bold text-gray-900 dark:text-white">
                      {selectedEntity.nom || 'Information'}
                    </h3>
                    <span className="text-xs bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300 px-2 py-0.5 rounded-full font-semibold capitalize">
                      {currentMapLevel.slice(0, -1)}
                    </span>
                  </div>

                  <div className="space-y-2">
                    {Object.entries(selectedEntity).map(([key, value]) => {
                      if (['id','created_at','updated_at'].includes(key) || !value) return null;
                      if (key === 'nom') return null; // already shown as title
                      return (
                        <div key={key} className="flex items-baseline justify-between border-b border-gray-100 dark:border-gray-800 pb-1.5">
                          <span className="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide">{key.replace(/_/g, ' ')}</span>
                          <span className="text-sm text-gray-800 dark:text-gray-200 font-medium text-right max-w-[55%] truncate">
                            {Array.isArray(value) ? value.join(', ') : String(value)}
                          </span>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Voir Plus button */}
                <Link
                  href={detailUrl}
                  className="anim-slideUp delay-100 flex items-center justify-center gap-2.5 w-full px-5 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-[1.02]"
                >
                  <ExternalLink className="w-5 h-5" />
                  Voir plus — Page détail
                </Link>
              </>
            ) : (
              <div className="text-center py-16 anim-fadeIn">
                <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                  <MapPin className="w-8 h-8 text-gray-300 dark:text-gray-600" />
                </div>
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  Cliquez sur une zone de la carte pour voir ses informations
                </p>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\components\Skeleton.tsx
================================================================================

'use client';

import React from 'react';

export const SkeletonCard = () => (
  <div className="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-800 animate-pulse">
    <div className="h-6 bg-gray-200 dark:bg-gray-800 rounded w-3/4 mb-3 animate-shimmer"></div>
    <div className="space-y-2">
      <div className="h-4 bg-gray-200 dark:bg-gray-800 rounded animate-shimmer"></div>
      <div className="h-4 bg-gray-200 dark:bg-gray-800 rounded w-5/6 animate-shimmer"></div>
    </div>
  </div>
);

export const SkeletonList = ({ count = 3 }: { count?: number }) => (
  <div className="space-y-3">
    {Array.from({ length: count }).map((_, i) => (
      <SkeletonCard key={i} />
    ))}
  </div>
);

export const SkeletonMap = () => (
  <div className="w-full h-full bg-gray-100 dark:bg-gray-900 animate-pulse flex items-center justify-center">
    <div className="text-center">
      <div className="inline-block w-16 h-16 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mb-4"></div>
      <p className="text-gray-600 dark:text-gray-400 font-medium">Chargement de la carte...</p>
    </div>
  </div>
);

export const SkeletonStat = () => (
  <div className="bg-white dark:bg-gray-900 rounded-xl p-6 border border-gray-200 dark:border-gray-800 animate-pulse">
    <div className="flex items-center justify-between mb-3">
      <div className="h-8 w-8 bg-gray-200 dark:bg-gray-800 rounded-lg animate-shimmer"></div>
      <div className="h-4 w-16 bg-gray-200 dark:bg-gray-800 rounded animate-shimmer"></div>
    </div>
    <div className="h-8 bg-gray-200 dark:bg-gray-800 rounded w-24 mb-2 animate-shimmer"></div>
    <div className="h-4 bg-gray-200 dark:bg-gray-800 rounded w-32 animate-shimmer"></div>
  </div>
);


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\components\ThemeToggle.tsx
================================================================================

'use client';

import { useEffect, useState } from 'react';
import { Moon, Sun } from 'lucide-react';

export default function ThemeToggle() {
  const [theme, setTheme] = useState<'light' | 'dark'>('light');
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    // Détecter le thème du navigateur au chargement
    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem('theme') as 'light' | 'dark' | null;
    const initialTheme = savedTheme || (isDark ? 'dark' : 'light');
    
    setTheme(initialTheme);
    document.documentElement.classList.toggle('dark', initialTheme === 'dark');

    // Écouter les changements de préférence du système
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    const handleChange = (e: MediaQueryListEvent) => {
      if (!localStorage.getItem('theme')) {
        const newTheme = e.matches ? 'dark' : 'light';
        setTheme(newTheme);
        document.documentElement.classList.toggle('dark', newTheme === 'dark');
      }
    };

    mediaQuery.addEventListener('change', handleChange);
    return () => mediaQuery.removeEventListener('change', handleChange);
  }, []);

  const toggleTheme = () => {
    const newTheme = theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    localStorage.setItem('theme', newTheme);
    document.documentElement.classList.toggle('dark', newTheme === 'dark');
  };

  if (!mounted) {
    return <div className="w-10 h-10" />;
  }

  return (
    <button
      onClick={toggleTheme}
      className="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 transform hover:scale-110"
      aria-label="Toggle theme"
      style={{
        animation: 'slideDown 0.5s ease-out',
      }}
    >
      {theme === 'light' ? (
        <Moon className="w-5 h-5 text-gray-700 dark:text-gray-300" />
      ) : (
        <Sun className="w-5 h-5 text-yellow-500" />
      )}
    </button>
  );
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\components\DetailMap.tsx
================================================================================

'use client';

import { useEffect, useRef } from 'react';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

const MAPTILER_API_KEY = "Lr72DkH8TYyjpP7RNZS9";

interface DetailMapProps {
  geoData: any;
  targetId: number;
}

export default function DetailMap({ geoData, targetId }: DetailMapProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const mapRef = useRef<L.Map | null>(null);
  const isCleaningUpRef = useRef(false);

  useEffect(() => {
    if (!containerRef.current || !geoData || isCleaningUpRef.current) return;

    // Destroy previous instance
    if (mapRef.current) {
      try {
        mapRef.current.off();
        mapRef.current.remove();
        mapRef.current = null;
      } catch (e) {
        console.warn('Error removing previous map:', e);
      }
    }

    console.log('%c🗺️  [DetailMap] Initializing detail map with MapTiler', 'color: #22c55e; font-weight: bold');

    try {
      const map = L.map(containerRef.current, {
        center: [7.3697, 12.3547],
        zoom: 6,
        zoomControl: true,
        preferCanvas: true,
        fadeAnimation: true,
        attributionControl: false,
      });

      // Attribution
      L.control.attribution({
        position: 'bottomright',
        prefix: false,
      }).addAttribution(
        '<a href="https://www.maptiler.com/copyright/" target="_blank">© MapTiler</a>'
      ).addTo(map);

      // MapTiler Satellite Hybrid (Pour les détails)
      L.tileLayer(
        `https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=${MAPTILER_API_KEY}`,
        {
          tileSize: 512,
          zoomOffset: -1,
          minZoom: 1,
          maxZoom: 20,
          crossOrigin: true,
        }
      ).addTo(map);

      let targetBounds: L.LatLngBounds | null = null;

      L.geoJSON(geoData, {
        style: (feature: any) => {
          const isTarget = feature?.properties?.id === targetId;
          return {
            fillColor: isTarget ? '#22c55e' : '#d1fae5',
            weight: isTarget ? 4 : 1.5,
            opacity: 1,
            color: isTarget ? '#15803d' : '#86efac',
            fillOpacity: isTarget ? 0.75 : 0.3,
          };
        },
        onEachFeature: (feature, layer) => {
          const name = feature.properties?.nom || feature.properties?.name || '';
          if (name) {
            layer.bindTooltip(name, {
              permanent: feature.properties?.id === targetId,
              direction: 'center',
              className: 'detail-map-tooltip',
            });
          }
          if (feature.properties?.id === targetId) {
            try {
              targetBounds = (layer as any).getBounds();
            } catch (_) {}
          }
        },
      }).addTo(map);

      // Zoom into target
      if (targetBounds && (targetBounds as L.LatLngBounds).isValid()) {
        map.fitBounds(targetBounds as L.LatLngBounds, {
          padding: [40, 40],
          maxZoom: 13,
          animate: true,
          duration: 0.8,
        });
      }

      mapRef.current = map;
    } catch (error) {
      console.error('%c❌ DetailMap init failed:', 'color: #ef4444', error);
    }

    return () => {
      isCleaningUpRef.current = true;
      if (mapRef.current) {
        try {
          mapRef.current.off();
          mapRef.current.remove();
          mapRef.current = null;
        } catch (e) {
          console.warn('Error cleaning up map:', e);
        }
      }
      isCleaningUpRef.current = false;
    };
  }, [geoData, targetId]);

  return (
    <>
      <div ref={containerRef} className="w-full h-full" />
      <style jsx global>{`
        .detail-map-tooltip {
          background: rgba(34, 197, 94, 0.95) !important;
          border: 2px solid #15803d !important;
          border-radius: 8px !important;
          padding: 8px 12px !important;
          font-weight: 700 !important;
          font-size: 14px !important;
          color: white !important;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        }
      `}</style>
    </>
  );
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\lib\api.ts
================================================================================

// ─── Service API avec cache optimisé + console logging ──────────────────────
import type {
  Region, Departement, Commune, Filiere, CategorieProduit, Produit,
  Production, Infrastructure, ApiResponse, GeoJSONFeatureCollection,
  StatistiquesGlobales, ZoneHalieutique, BassinProduction, SourceDonnees,
} from '@/types/api';

// Utilise les rewrites Next.js en production, direct en dev pour les logs
const API_BASE_URL = process.env.NODE_ENV === 'production' 
  ? '' // Utilise les rewrites (pas de préfixe)
  : 'https://apiti.onrender.com'; // Direct en dev

// ─── Cache amélioré (TTL 10 min pour GeoJSON, 5 min pour le reste) ──────────
const CACHE_TTL_GEOJSON = 10 * 60 * 1000; // 10 minutes pour GeoJSON
const CACHE_TTL_DEFAULT = 5 * 60 * 1000;  // 5 minutes pour le reste

interface CacheEntry<T> { data: T; timestamp: number; }
const cache = new Map<string, CacheEntry<any>>();

function getFromCache<T>(key: string, ttl: number = CACHE_TTL_DEFAULT): T | null {
  const e = cache.get(key);
  if (!e) return null;
  if (Date.now() - e.timestamp > ttl) { 
    cache.delete(key); 
    return null; 
  }
  return e.data as T;
}

function setInCache<T>(key: string, data: T) { 
  cache.set(key, { data, timestamp: Date.now() }); 
}

// ─── Nettoyage périodique du cache ───────────────────────────────────────────
setInterval(() => {
  const now = Date.now();
  for (const [key, entry] of cache.entries()) {
    if (now - entry.timestamp > CACHE_TTL_GEOJSON) {
      cache.delete(key);
    }
  }
}, 60000); // Nettoie toutes les minutes

// ─── Core fetch optimisé ─────────────────────────────────────────────────────
async function fetchAPI<T>(
  endpoint: string, 
  options?: RequestInit & { useCache?: boolean; cacheTTL?: number }
): Promise<T> {
  const url = `${API_BASE_URL}${endpoint}`;
  const useCache = options?.useCache ?? false;
  const cacheTTL = options?.cacheTTL ?? CACHE_TTL_DEFAULT;

  if (useCache) {
    const cached = getFromCache<T>(endpoint, cacheTTL);
    if (cached) {
      console.log('%c[API ⚡ CACHE] %c' + endpoint, 'color:#10b981;font-weight:700', 'color:#6b7280');
      return cached;
    }
  }

  console.log('%c[API →] %c' + endpoint, 'color:#3b82f6;font-weight:700', 'color:#6b7280');
  const start = performance.now();

  try {
    const { useCache: _, cacheTTL: __, ...fetchOpts } = options || {};
    const response = await fetch(url, { 
      ...fetchOpts, 
      headers: { 
        'Content-Type': 'application/json', 
        ...fetchOpts?.headers 
      },
      // Ajout de timeout
      signal: AbortSignal.timeout(15000) // 15 secondes max
    });
    
    const elapsed = (performance.now() - start).toFixed(1);

    if (!response.ok) {
      const errText = await response.text();
      console.error('%c[API ✕] %c' + endpoint + ' — ' + response.status, 'color:#ef4444;font-weight:700', 'color:#6b7280', errText);
      throw new Error(`API Error: ${response.status} - ${errText}`);
    }

    const data = await response.json();
    console.log('%c[API ✓] %c' + endpoint + ' %c(' + elapsed + ' ms)', 'color:#22c55e;font-weight:700', 'color:#6b7280', 'color:#9ca3af');
    
    if (useCache) setInCache(endpoint, data);
    return data;
  } catch (error) {
    if (error instanceof Error && error.name === 'TimeoutError') {
      console.error('%c[API ⏱️  TIMEOUT] %c' + endpoint, 'color:#f59e0b;font-weight:700', 'color:#6b7280');
    } else {
      console.error('%c[API ✕] %c' + endpoint, 'color:#ef4444;font-weight:700', 'color:#6b7280', error);
    }
    throw error;
  }
}

// ─── RÉGIONS ─────────────────────────────────────────────────────────────────
export const getRegions = (skip=0, limit=100) => 
  fetchAPI<ApiResponse<Region>>(`/api/v1/regions/?skip=${skip}&limit=${limit}`, {useCache:true});

export const searchRegions = (q:string, limit=10) => 
  fetchAPI<Region[]>(`/api/v1/regions/search?q=${encodeURIComponent(q)}&limit=${limit}`);

export const getRegion = (id:number) => 
  fetchAPI<Region>(`/api/v1/regions/${id}`, {useCache:true});

export const getRegionDepartements = (id:number) => 
  fetchAPI<Departement[]>(`/api/v1/regions/${id}/departements`, {useCache:true});

export const getRegionProductions = (id:number, annee?:number, produitId?:number, limit=100) => {
  let u = `/api/v1/regions/${id}/productions?limit=${limit}`;
  if(annee) u+=`&annee=${annee}`; 
  if(produitId) u+=`&produit_id=${produitId}`;
  return fetchAPI<Production[]>(u);
};

// ─── DÉPARTEMENTS ───────────────────────────────────────────────────────────
export const getDepartements = (skip=0, limit=100, regionId?:number) => {
  let u = `/api/v1/departements/?skip=${skip}&limit=${limit}`;
  if(regionId) u+=`&region_id=${regionId}`;
  return fetchAPI<ApiResponse<Departement>>(u, {useCache:true});
};

export const searchDepartements = (q:string, limit=10) => 
  fetchAPI<Departement[]>(`/api/v1/departements/search?q=${encodeURIComponent(q)}&limit=${limit}`);

export const getDepartement = (id:number) => 
  fetchAPI<Departement>(`/api/v1/departements/${id}`, {useCache:true});

export const getDepartementCommunes = (id:number) => 
  fetchAPI<Commune[]>(`/api/v1/departements/${id}/communes`, {useCache:true});

export const getDepartementProductions = (id:number, annee?:number, produitId?:number, limit=100) => {
  let u = `/api/v1/departements/${id}/productions?limit=${limit}`;
  if(annee) u+=`&annee=${annee}`; 
  if(produitId) u+=`&produit_id=${produitId}`;
  return fetchAPI<Production[]>(u);
};

// ─── COMMUNES ────────────────────────────────────────────────────────────────
export const getCommunes = (skip=0, limit=100, deptId?:number, type?:string) => {
  let u = `/api/v1/communes/?skip=${skip}&limit=${limit}`;
  if(deptId) u+=`&departement_id=${deptId}`; 
  if(type) u+=`&type_commune=${type}`;
  return fetchAPI<ApiResponse<Commune>>(u, {useCache:true});
};

export const searchCommunes = (q:string, limit=10, deptId?:number) => {
  let u = `/api/v1/communes/search?q=${encodeURIComponent(q)}&limit=${limit}`;
  if(deptId) u+=`&departement_id=${deptId}`;
  return fetchAPI<Commune[]>(u);
};

export const getCommune = (id:number) => 
  fetchAPI<Commune>(`/api/v1/communes/${id}`, {useCache:true});

export const getCommuneInfrastructures = (id:number) => 
  fetchAPI<Infrastructure[]>(`/api/v1/communes/${id}/infrastructures`, {useCache:true});

export const getCommuneProductions = (id:number, annee?:number, produitId?:number, limit=100) => {
  let u = `/api/v1/communes/${id}/productions?limit=${limit}`;
  if(annee) u+=`&annee=${annee}`; 
  if(produitId) u+=`&produit_id=${produitId}`;
  return fetchAPI<Production[]>(u);
};

export const getCommuneResume = (id:number) => 
  fetchAPI<any>(`/api/v1/communes/${id}/resume`, {useCache:true});

// ─── FILIÈRES ────────────────────────────────────────────────────────────────
export const getFilieres = (skip=0, limit=100) => 
  fetchAPI<ApiResponse<Filiere>>(`/api/v1/filieres/?skip=${skip}&limit=${limit}`, {useCache:true});

export const searchFilieres = (q:string, limit=10) => 
  fetchAPI<Filiere[]>(`/api/v1/filieres/search?q=${encodeURIComponent(q)}&limit=${limit}`);

export const getFiliere = (id:number) => 
  fetchAPI<Filiere>(`/api/v1/filieres/${id}`, {useCache:true});

export const getFiliereCategories = (id:number) => 
  fetchAPI<CategorieProduit[]>(`/api/v1/filieres/${id}/categories`, {useCache:true});

export const getFiliereProduits = (id:number) => 
  fetchAPI<Produit[]>(`/api/v1/filieres/${id}/produits`, {useCache:true});

// ─── CATÉGORIES ──────────────────────────────────────────────────────────────
export const getCategories = (skip=0, limit=100, filiereId?:number) => {
  let u = `/api/v1/categories/?skip=${skip}&limit=${limit}`;
  if(filiereId) u+=`&filiere_id=${filiereId}`;
  return fetchAPI<ApiResponse<CategorieProduit>>(u, {useCache:true});
};

export const getCategorie = (id:number) => 
  fetchAPI<CategorieProduit>(`/api/v1/categories/${id}`, {useCache:true});

export const getCategorieProduits = (id:number) => 
  fetchAPI<Produit[]>(`/api/v1/categories/${id}/produits`, {useCache:true});

// ─── PRODUITS ────────────────────────────────────────────────────────────────
export const getProduits = (skip=0, limit=100, catId?:number, filId?:number) => {
  let u = `/api/v1/produits/?skip=${skip}&limit=${limit}`;
  if(catId) u+=`&categorie_id=${catId}`; 
  if(filId) u+=`&filiere_id=${filId}`;
  return fetchAPI<ApiResponse<Produit>>(u, {useCache:true});
};

export const searchProduits = (q:string, limit=10, catId?:number, filId?:number) => {
  let u = `/api/v1/produits/search?q=${encodeURIComponent(q)}&limit=${limit}`;
  if(catId) u+=`&categorie_id=${catId}`; 
  if(filId) u+=`&filiere_id=${filId}`;
  return fetchAPI<Produit[]>(u);
};

export const getProduit = (id:number) => 
  fetchAPI<Produit>(`/api/v1/produits/${id}`, {useCache:true});

export const getProduitResume = (id:number, annee?:number) => {
  let u = `/api/v1/produits/${id}/resume`; 
  if(annee) u+=`?annee=${annee}`;
  return fetchAPI<any>(u);
};

// ─── PRODUCTIONS ─────────────────────────────────────────────────────────────
export const getProductions = (params: Record<string,any>) => {
  const sp = new URLSearchParams();
  Object.entries(params).forEach(([k,v])=> { 
    if(v!=null) sp.append(k,String(v)); 
  });
  return fetchAPI<ApiResponse<Production>>(`/api/v1/productions/?${sp}`);
};

export const getAnneesDisponibles = () => 
  fetchAPI<number[]>(`/api/v1/productions/annees`, {useCache:true, cacheTTL: CACHE_TTL_GEOJSON});

export const getSaisonsDisponibles = () => 
  fetchAPI<string[]>(`/api/v1/productions/saisons`, {useCache:true, cacheTTL: CACHE_TTL_GEOJSON});

export const getProductionsResume = (annee?:number) => 
  fetchAPI<any>(`/api/v1/productions/resume${annee?'?annee='+annee:''}`);

export const getProductionsParAnnee = (produitId?:number, regionId?:number, anneeDebut?:number, anneeFin?:number) => {
  const p = new URLSearchParams();
  if(produitId) p.append('produit_id',String(produitId));
  if(regionId) p.append('region_id',String(regionId));
  if(anneeDebut) p.append('annee_debut',String(anneeDebut));
  if(anneeFin) p.append('annee_fin',String(anneeFin));
  return fetchAPI<any>(`/api/v1/productions/par-annee${p.toString()?'?'+p:''}`);
};

export const getProductionsParRegion = (annee?:number, produitId?:number) => {
  const p=new URLSearchParams(); 
  if(annee) p.append('annee',String(annee)); 
  if(produitId) p.append('produit_id',String(produitId));
  return fetchAPI<any>(`/api/v1/productions/par-region${p.toString()?'?'+p:''}`);
};

export const getProductionsParProduit = (annee?:number, regionId?:number) => {
  const p=new URLSearchParams(); 
  if(annee) p.append('annee',String(annee)); 
  if(regionId) p.append('region_id',String(regionId));
  return fetchAPI<any>(`/api/v1/productions/par-produit${p.toString()?'?'+p:''}`);
};

// ─── BASSINS ─────────────────────────────────────────────────────────────────
export const getBassins = (skip=0,limit=100,filId?:number) => {
  let u=`/api/v1/bassins/?skip=${skip}&limit=${limit}`; 
  if(filId) u+=`&filiere_id=${filId}`;
  return fetchAPI<ApiResponse<BassinProduction>>(u,{useCache:true});
};

export const searchBassins = (q:string,limit=10) => 
  fetchAPI<BassinProduction[]>(`/api/v1/bassins/search?q=${encodeURIComponent(q)}&limit=${limit}`);

export const getBassin = (id:number) => 
  fetchAPI<BassinProduction>(`/api/v1/bassins/${id}`,{useCache:true});

export const getBassinGeoJSON = (id:number) => 
  fetchAPI<GeoJSONFeatureCollection>(`/api/v1/bassins/${id}/geojson`,{useCache:true, cacheTTL: CACHE_TTL_GEOJSON});

export const getBassinsFilierGeoJSON = (id:number)=> 
  fetchAPI<GeoJSONFeatureCollection>(`/api/v1/bassins/filiere/${id}/geojson`,{useCache:true, cacheTTL: CACHE_TTL_GEOJSON});

// ─── ZONES HALIEUTIQUES ──────────────────────────────────────────────────────
export const getZonesHalieutiques = (skip=0,limit=100,type?:string) => {
  let u=`/api/v1/zones-halieutiques/?skip=${skip}&limit=${limit}`; 
  if(type) u+=`&type_zone=${type}`;
  return fetchAPI<ApiResponse<ZoneHalieutique>>(u,{useCache:true});
};

export const getTypesZones = () => 
  fetchAPI<string[]>(`/api/v1/zones-halieutiques/types`,{useCache:true, cacheTTL: CACHE_TTL_GEOJSON});

export const getZoneHalieutique = (id:number) => 
  fetchAPI<ZoneHalieutique>(`/api/v1/zones-halieutiques/${id}`,{useCache:true});

export const getZoneHalieutiqueGeoJSON = (id:number) => 
  fetchAPI<GeoJSONFeatureCollection>(`/api/v1/zones-halieutiques/${id}/geojson`,{useCache:true, cacheTTL: CACHE_TTL_GEOJSON});

// ─── INFRASTRUCTURES ────────────────────────────────────────────────────────
export const getInfrastructures = (skip=0,limit=100,type?:string,communeId?:number) => {
  let u=`/api/v1/infrastructures/?skip=${skip}&limit=${limit}`;
  if(type) u+=`&type_infrastructure=${type}`; 
  if(communeId) u+=`&commune_id=${communeId}`;
  return fetchAPI<ApiResponse<Infrastructure>>(u,{useCache:true});
};

export const getTypesInfrastructures = () => 
  fetchAPI<string[]>(`/api/v1/infrastructures/types`,{useCache:true, cacheTTL: CACHE_TTL_GEOJSON});

export const getStatsInfrastructures = () => 
  fetchAPI<any>(`/api/v1/infrastructures/stats`,{useCache:true});

export const getInfrastructure = (id:number) => 
  fetchAPI<Infrastructure>(`/api/v1/infrastructures/${id}`,{useCache:true});

export const getInfrastructureGeoJSON = (id:number) => 
  fetchAPI<GeoJSONFeatureCollection>(`/api/v1/infrastructures/${id}/geojson`,{useCache:true, cacheTTL: CACHE_TTL_GEOJSON});

// ─── STATISTIQUES ────────────────────────────────────────────────────────────
export const getStatistiquesGlobales = () => 
  fetchAPI<StatistiquesGlobales>(`/api/v1/statistiques/globales`,{useCache:true, cacheTTL: CACHE_TTL_GEOJSON});

export const getStatistiquesProduction = (annee?:number) => 
  fetchAPI<any>(`/api/v1/statistiques/production${annee?'?annee='+annee:''}`);

export const getEvolutionProduction = (produitId?:number,regionId?:number,anneeDebut?:number,anneeFin?:number) => {
  const p=new URLSearchParams();
  if(produitId) p.append('produit_id',String(produitId)); 
  if(regionId) p.append('region_id',String(regionId));
  if(anneeDebut) p.append('annee_debut',String(anneeDebut)); 
  if(anneeFin) p.append('annee_fin',String(anneeFin));
  return fetchAPI<any>(`/api/v1/statistiques/evolution${p.toString()?'?'+p:''}`);
};

export const getTopRegions = (annee?:number,produitId?:number,limit=10) => {
  let u=`/api/v1/statistiques/top-regions?limit=${limit}`;
  if(annee) u+=`&annee=${annee}`; 
  if(produitId) u+=`&produit_id=${produitId}`;
  return fetchAPI<any>(u);
};

export const getTopProduits = (annee?:number,regionId?:number,limit=10) => {
  let u=`/api/v1/statistiques/top-produits?limit=${limit}`;
  if(annee) u+=`&annee=${annee}`; 
  if(regionId) u+=`&region_id=${regionId}`;
  return fetchAPI<any>(u);
};

export const comparerAnnees = (ref:number,cmp:number,produitId?:number,regionId?:number) => {
  let u=`/api/v1/statistiques/comparaison/annees?annee_reference=${ref}&annee_comparaison=${cmp}`;
  if(produitId) u+=`&produit_id=${produitId}`; 
  if(regionId) u+=`&region_id=${regionId}`;
  return fetchAPI<any>(u);
};

// ─── SOURCES ─────────────────────────────────────────────────────────────────
export const getSources = (skip=0,limit=100) => 
  fetchAPI<ApiResponse<SourceDonnees>>(`/api/v1/sources/?skip=${skip}&limit=${limit}`,{useCache:true});

export const getSource = (id:number) => 
  fetchAPI<SourceDonnees>(`/api/v1/sources/${id}`,{useCache:true});

// ─── GEOJSON (Cache long - 10 min) ──────────────────────────────────────────
export const getRegionsGeoJSON = () => 
  fetchAPI<GeoJSONFeatureCollection>(`/api/v1/geojson/regions`,{useCache:true, cacheTTL: CACHE_TTL_GEOJSON});

export const getDepartementsGeoJSON = (regionId?:number) => 
  fetchAPI<GeoJSONFeatureCollection>(
    `/api/v1/geojson/departements${regionId?'?region_id='+regionId:''}`,
    {useCache:true, cacheTTL: CACHE_TTL_GEOJSON}
  );

export const getCommunesGeoJSON = (deptId?:number) => 
  fetchAPI<GeoJSONFeatureCollection>(
    `/api/v1/geojson/communes${deptId?'?departement_id='+deptId:''}`,
    {useCache:true, cacheTTL: CACHE_TTL_GEOJSON}
  );

export const getZonesHalieutiquesGeoJSON = (type?:string) => 
  fetchAPI<GeoJSONFeatureCollection>(
    `/api/v1/geojson/zones-halieutiques${type?'?type_zone='+type:''}`,
    {useCache:true, cacheTTL: CACHE_TTL_GEOJSON}
  );

export const getBassinsGeoJSON = (filId?:number) => 
  fetchAPI<GeoJSONFeatureCollection>(
    `/api/v1/geojson/bassins${filId?'?filiere_id='+filId:''}`,
    {useCache:true, cacheTTL: CACHE_TTL_GEOJSON}
  );

export const getInfrastructuresGeoJSON = (type?:string,communeId?:number) => {
  const p=new URLSearchParams(); 
  if(type) p.append('type_infrastructure',type); 
  if(communeId) p.append('commune_id',String(communeId));
  return fetchAPI<GeoJSONFeatureCollection>(
    `/api/v1/geojson/infrastructures${p.toString()?'?'+p:''}`,
    {useCache:true, cacheTTL: CACHE_TTL_GEOJSON}
  );
};


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\types\api.ts
================================================================================

// ─── Types pour l'API Cameroun WebMapping ───────────────────────────────────

export interface Region {
  id: number;
  nom: string;
  code_region: string;
  chef_lieu: string | null;
  superficie_km2: number | null;
  population: number | null;
  created_at: string | null;
  updated_at: string | null;
}

export interface Departement {
  id: number;
  nom: string;
  code_departement: string;
  chef_lieu: string | null;
  superficie_km2: number | null;
  population: number | null;
  region_id: number;
  created_at: string | null;
  updated_at: string | null;
}

export interface Commune {
  id: number;
  nom: string;
  code_commune: string;
  departement_id: number;
  type_commune: string | null;
  population: number | null;
  superficie_km2: number | null;
  created_at: string | null;
  updated_at: string | null;
}

export interface Filiere {
  id: number;
  nom: string;
  code: string;
  description: string | null;
  couleur: string | null;
  icone: string | null;
  created_at: string | null;
}

export interface CategorieProduit {
  id: number;
  nom: string;
  code: string;
  filiere_id: number;
  description: string | null;
  icone: string | null;
  created_at: string | null;
}

export interface Produit {
  id: number;
  nom: string;
  code: string;
  categorie_id: number;
  nom_scientifique: string | null;
  unite_mesure: string | null;
  description: string | null;
  icone: string | null;
  couleur: string | null;
  created_at: string | null;
}

export interface Production {
  id: number;
  produit_id: number;
  annee: number;
  region_id: number | null;
  departement_id: number | null;
  commune_id: number | null;
  saison: string | null;
  quantite: number | null;
  valeur_fcfa: number | null;
  superficie_ha: number | null;
  rendement: number | null;
  nombre_producteurs: number | null;
  source_donnees: string | null;
  fiabilite: string | null;
  notes: string | null;
  created_at: string | null;
  updated_at: string | null;
}

export interface Infrastructure {
  id: number;
  nom: string;
  type_infrastructure: string | null;
  commune_id: number | null;
  capacite: string | null;
  adresse: string | null;
  contact: string | null;
  created_at: string | null;
}

export interface ZoneHalieutique {
  id: number;
  nom: string;
  type_zone: string | null;
  superficie_km2: number | null;
  departements_concernes: string[] | null;
  especes_principales: string[] | null;
  created_at: string | null;
}

export interface BassinProduction {
  id: number;
  nom: string;
  code: string;
  filiere_id: number;
  description: string | null;
  produits_dominants: string[] | null;
  importance: string | null;
  created_at: string | null;
}

export interface SourceDonnees {
  id: number;
  nom: string;
  code: string;
  description: string | null;
  url: string | null;
  contact: string | null;
  fiabilite: string | null;
  created_at: string | null;
}

// ─── GeoJSON ─────────────────────────────────────────────────────────────────
export interface GeoJSONFeature {
  type: 'Feature';
  geometry: { type: string; coordinates: any };
  properties: Record<string, any>;
}

export interface GeoJSONFeatureCollection {
  type: 'FeatureCollection';
  features: GeoJSONFeature[];
}

// ─── API wrappers ────────────────────────────────────────────────────────────
export interface ApiResponse<T> {
  total: number;
  items: T[];
}

export interface StatistiquesGlobales {
  total_regions: number;
  total_departements: number;
  total_communes: number;
  total_filieres: number;
  total_produits: number;
  total_productions: number;
}

// ─── Stats types (loose – backend returns dynamic shapes) ───────────────────
export interface ProductionParAnnee {
  annee: number;
  total_quantite?: number;
  total_valeur_fcfa?: number;
  nombre_productions?: number;
  [key: string]: any;
}

export interface TopRegionItem {
  region_id?: number;
  nom?: string;
  total_quantite?: number;
  total_valeur_fcfa?: number;
  nombre_productions?: number;
  [key: string]: any;
}

export interface TopProduitItem {
  produit_id?: number;
  nom?: string;
  total_quantite?: number;
  total_valeur_fcfa?: number;
  nombre_productions?: number;
  [key: string]: any;
}

export interface ComparaisonAnnees {
  annee_reference: number;
  annee_comparaison: number;
  [key: string]: any;
}

// ─── App ─────────────────────────────────────────────────────────────────────
export type MapLevel = 'regions' | 'departements' | 'communes';

export interface FilterState {
  filiere_id: number | null;
  categorie_id: number | null;
  produit_id: number | null;
  annee: number | null;
}


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\utils\helper.ts
================================================================================

// Utilitaires pour l'application

/**
 * Formate un nombre avec séparateurs de milliers
 */
export const formatNumber = (num: number): string => {
  return new Intl.NumberFormat('fr-FR').format(num);
};

/**
 * Formate une valeur monétaire en FCFA
 */
export const formatCurrency = (value: number): string => {
  return `${formatNumber(value)} FCFA`;
};

/**
 * Formate une superficie en hectares ou km²
 */
export const formatSuperficie = (value: number, unit: 'ha' | 'km2' = 'ha'): string => {
  return `${formatNumber(value)} ${unit === 'ha' ? 'ha' : 'km²'}`;
};

/**
 * Tronque un texte avec ellipse
 */
export const truncateText = (text: string, maxLength: number = 50): string => {
  if (text.length <= maxLength) return text;
  return text.slice(0, maxLength) + '...';
};

/**
 * Génère une couleur aléatoire pour les visualisations
 */
export const generateRandomColor = (): string => {
  const colors = [
    '#22c55e', // green-500
    '#10b981', // emerald-500
    '#14b8a6', // teal-500
    '#06b6d4', // cyan-500
    '#3b82f6', // blue-500
    '#6366f1', // indigo-500
    '#8b5cf6', // violet-500
    '#a855f7', // purple-500
  ];
  return colors[Math.floor(Math.random() * colors.length)];
};

/**
 * Détermine la couleur en fonction d'une valeur
 */
export const getColorByValue = (value: number, max: number): string => {
  const percentage = (value / max) * 100;
  
  if (percentage >= 75) return '#22c55e'; // vert foncé
  if (percentage >= 50) return '#86efac'; // vert clair
  if (percentage >= 25) return '#fbbf24'; // jaune
  return '#f87171'; // rouge
};

/**
 * Calcule le pourcentage
 */
export const calculatePercentage = (value: number, total: number): number => {
  if (total === 0) return 0;
  return Math.round((value / total) * 100);
};

/**
 * Formate une date
 */
export const formatDate = (date: string | Date): string => {
  return new Intl.DateTimeFormat('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(new Date(date));
};

/**
 * Génère un ID unique
 */
export const generateId = (): string => {
  return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
};

/**
 * Debounce une fonction
 */
export const debounce = <T extends (...args: any[]) => any>(
  func: T,
  wait: number
): ((...args: Parameters<T>) => void) => {
  let timeout: NodeJS.Timeout;
  
  return (...args: Parameters<T>) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
};

/**
 * Classe CSS conditionnelle
 */
export const cn = (...classes: (string | boolean | undefined | null)[]): string => {
  return classes.filter(Boolean).join(' ');
};

/**
 * Vérifie si une valeur est vide
 */
export const isEmpty = (value: any): boolean => {
  if (value === null || value === undefined) return true;
  if (typeof value === 'string') return value.trim().length === 0;
  if (Array.isArray(value)) return value.length === 0;
  if (typeof value === 'object') return Object.keys(value).length === 0;
  return false;
};

/**
 * Extrait les coordonnées d'un objet GeoJSON
 */
export const extractCoordinates = (geometry: any): [number, number] | null => {
  if (!geometry || !geometry.coordinates) return null;
  
  try {
    if (geometry.type === 'Point') {
      return [geometry.coordinates[1], geometry.coordinates[0]];
    }
    if (geometry.type === 'Polygon') {
      const coords = geometry.coordinates[0][0];
      return [coords[1], coords[0]];
    }
    if (geometry.type === 'MultiPolygon') {
      const coords = geometry.coordinates[0][0][0];
      return [coords[1], coords[0]];
    }
  } catch (error) {
    console.error('Erreur lors de l\'extraction des coordonnées:', error);
  }
  
  return null;
};

/**
 * Calcule le centre d'un polygon
 */
export const calculateCenter = (coordinates: number[][][]): [number, number] => {
  let totalLat = 0;
  let totalLng = 0;
  let count = 0;
  
  coordinates[0].forEach(([lng, lat]) => {
    totalLat += lat;
    totalLng += lng;
    count++;
  });
  
  return [totalLat / count, totalLng / count];
};

/**
 * Trie un tableau d'objets par propriété
 */
export const sortBy = <T>(
  array: T[],
  key: keyof T,
  order: 'asc' | 'desc' = 'asc'
): T[] => {
  return [...array].sort((a, b) => {
    const aVal = a[key];
    const bVal = b[key];
    
    if (aVal === bVal) return 0;
    
    const comparison = aVal > bVal ? 1 : -1;
    return order === 'asc' ? comparison : -comparison;
  });
};

/**
 * Groupe un tableau par propriété
 */
export const groupBy = <T>(
  array: T[],
  key: keyof T
): Record<string, T[]> => {
  return array.reduce((acc, item) => {
    const group = String(item[key]);
    if (!acc[group]) {
      acc[group] = [];
    }
    acc[group].push(item);
    return acc;
  }, {} as Record<string, T[]>);
};

/**
 * Convertit une chaîne en slug
 */
export const slugify = (text: string): string => {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-\-+/g, '-');
};

/**
 * Copie du texte dans le presse-papiers
 */
export const copyToClipboard = async (text: string): Promise<boolean> => {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch (error) {
    console.error('Erreur lors de la copie:', error);
    return false;
  }
};

/**
 * Télécharge un fichier JSON
 */
export const downloadJSON = (data: any, filename: string): void => {
  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: 'application/json',
  });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
};

/**
 * Télécharge un fichier CSV
 */
export const downloadCSV = (data: any[], filename: string): void => {
  if (data.length === 0) return;
  
  const headers = Object.keys(data[0]).join(',');
  const rows = data.map(obj => 
    Object.values(obj).map(val => `"${val}"`).join(',')
  );
  const csv = [headers, ...rows].join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
};


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\utils\constant.ts
================================================================================

// Constantes de l'application

export const APP_NAME = 'AgriVision';
export const APP_DESCRIPTION = 'Plateforme de cartographie des données agricoles du Cameroun';

// Configuration de la carte
export const MAP_CONFIG = {
  DEFAULT_CENTER: [7.3697, 12.3547] as [number, number], // Centre du Cameroun
  DEFAULT_ZOOM: 6,
  MIN_ZOOM: 5,
  MAX_ZOOM: 18,
  TILE_URL: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  ATTRIBUTION: '© OpenStreetMap contributors',
} as const;

// Couleurs des niveaux de carte
export const MAP_LEVEL_COLORS = {
  regions: {
    fill: '#86efac',
    border: '#16a34a',
    selected: '#22c55e',
  },
  departements: {
    fill: '#6ee7b7',
    border: '#059669',
    selected: '#10b981',
  },
  communes: {
    fill: '#5eead4',
    border: '#0d9488',
    selected: '#14b8a6',
  },
} as const;

// Limites de pagination
export const PAGINATION = {
  DEFAULT_LIMIT: 100,
  MAX_LIMIT: 500,
  DEFAULT_SKIP: 0,
} as const;

// Délais pour les opérations asynchrones
export const DELAYS = {
  DEBOUNCE_SEARCH: 500,
  AUTO_REFRESH: 60000, // 1 minute
  TOAST_DURATION: 3000,
  ANIMATION_DURATION: 300,
} as const;

// Messages d'erreur
export const ERROR_MESSAGES = {
  NETWORK_ERROR: 'Erreur de connexion. Veuillez vérifier votre connexion internet.',
  API_ERROR: 'Erreur lors de la récupération des données. Veuillez réessayer.',
  NOT_FOUND: 'Ressource non trouvée.',
  UNKNOWN_ERROR: 'Une erreur inattendue s\'est produite.',
  EMPTY_RESULT: 'Aucun résultat trouvé.',
} as const;

// Messages de succès
export const SUCCESS_MESSAGES = {
  DATA_LOADED: 'Données chargées avec succès',
  FILTER_APPLIED: 'Filtres appliqués',
  COPIED: 'Copié dans le presse-papiers',
} as const;

// Types de filières (exemples)
export const FILIERE_TYPES = [
  'Agriculture',
  'Élevage',
  'Pêche',
  'Foresterie',
] as const;

// Types de communes
export const COMMUNE_TYPES = [
  'urbaine',
  'rurale',
] as const;

// Types de zones halieutiques
export const ZONE_HALIEUTIQUE_TYPES = [
  'maritime',
  'fluviale',
  'lacustre',
] as const;

// Types d'infrastructures
export const INFRASTRUCTURE_TYPES = [
  'marché',
  'entrepôt',
  'coopérative',
  'usine_transformation',
  'point_collecte',
] as const;

// Unités de mesure
export const UNITES_MESURE = [
  'kg',
  'tonne',
  'litre',
  'unité',
  'sac',
] as const;

// Niveaux de fiabilité
export const NIVEAUX_FIABILITE = [
  'haute',
  'moyenne',
  'faible',
] as const;

// Saisons
export const SAISONS = [
  'saison_sèche',
  'saison_pluies',
  'toute_année',
] as const;

// Régions du Cameroun (pour référence)
export const CAMEROUN_REGIONS = [
  'Adamaoua',
  'Centre',
  'Est',
  'Extrême-Nord',
  'Littoral',
  'Nord',
  'Nord-Ouest',
  'Ouest',
  'Sud',
  'Sud-Ouest',
] as const;

// Routes de l'application
export const ROUTES = {
  HOME: '/',
  MAP: '/map',
  ABOUT: '/about',
  STATS: '/stats',
} as const;

// Configuration du thème
export const THEME = {
  COLORS: {
    primary: {
      50: '#f0fdf4',
      100: '#dcfce7',
      200: '#bbf7d0',
      300: '#86efac',
      400: '#4ade80',
      500: '#22c55e',
      600: '#16a34a',
      700: '#15803d',
      800: '#166534',
      900: '#14532d',
      950: '#052e16',
    },
  },
  FONTS: {
    display: 'Montserrat, system-ui, sans-serif',
    body: 'Open Sans, system-ui, sans-serif',
  },
} as const;

// Tailles d'écran (breakpoints Tailwind)
export const BREAKPOINTS = {
  sm: 640,
  md: 768,
  lg: 1024,
  xl: 1280,
  '2xl': 1536,
} as const;

// Configuration du cache
export const CACHE_CONFIG = {
  ENABLED: true,
  TTL: 300000, // 5 minutes
  MAX_SIZE: 100, // nombre maximum d'entrées
} as const;

// Formats d'export
export const EXPORT_FORMATS = [
  'json',
  'csv',
  'geojson',
  'pdf',
] as const;

// Configuration des animations
export const ANIMATION_CONFIG = {
  EASE: 'ease-out',
  DURATION: {
    fast: 150,
    normal: 300,
    slow: 500,
  },
} as const;

// Icônes par filière (mapping)
export const FILIERE_ICONS: Record<string, string> = {
  agriculture: '🌾',
  elevage: '🐄',
  peche: '🐟',
  foresterie: '🌳',
} as const;

// Emojis pour les statistiques
export const STAT_EMOJIS = {
  production: '📊',
  superficie: '📏',
  producteurs: '👥',
  valeur: '💰',
  rendement: '📈',
} as const;


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\eslint.config.mjs
================================================================================

import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;



================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\next-env.d.ts
================================================================================

/// <reference types="next" />
/// <reference types="next/image-types/global" />
/// <reference path="./.next/types/routes.d.ts" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.



================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\README.md
================================================================================

# 🌿 AgriVision

Plateforme web moderne de cartographie interactive pour visualiser et analyser les données de production agricole, pastorale et halieutique du Cameroun.

## ✨ Fonctionnalités

- 🗺️ **Carte Interactive** - Visualisation des divisions administratives (régions, départements, communes)
- 🌾 **Filières Agricoles** - Exploration des différentes filières et leurs produits
- 📊 **Statistiques Détaillées** - Données de production avec filtres multiples
- 🎨 **Design Moderne** - Interface élégante avec support du mode sombre/clair
- ⚡ **Performance Optimale** - Chargement rapide avec skeleton screens
- 📱 **Responsive** - Interface adaptée à tous les écrans
- 🔍 **Recherche Avancée** - Recherche et filtrage par filière, catégorie, produit, année
- 🗺️ **Zoom Intelligent** - Zoom automatique sur les zones sélectionnées
- 📈 **Visualisations** - Graphiques et statistiques en temps réel

## 🚀 Technologies

- **Next.js 14** - Framework React avec App Router
- **TypeScript** - Typage statique
- **Tailwind CSS** - Framework CSS utilitaire
- **Leaflet** - Bibliothèque de cartographie
- **Lucide React** - Icônes modernes
- **API Backend** - https://apiti.onrender.com

## 📦 Installation

### Prérequis

- Node.js 18+ 
- npm ou yarn

### Installation des dépendances

```bash
npm install
# ou
yarn install
```

### Lancement en développement

```bash
npm run dev
# ou
yarn dev
```

Ouvrez [http://localhost:3000](http://localhost:3000) dans votre navigateur.

### Build de production

```bash
npm run build
npm start
# ou
yarn build
yarn start
```

## 🎨 Structure du Projet

```
cameroun-agro-map/
├── app/                      # Pages Next.js (App Router)
│   ├── layout.tsx           # Layout principal
│   ├── page.tsx             # Page d'accueil
│   ├── map/                 # Page de la carte
│   │   └── page.tsx
│   └── globals.css          # Styles globaux
├── components/               # Composants réutilisables
│   ├── MapView.tsx          # Composant de la carte Leaflet
│   ├── Sidebar.tsx          # Barre latérale avec filtres
│   ├── Skeleton.tsx         # Composants de chargement
│   └── ThemeToggle.tsx      # Bouton de changement de thème
├── lib/                      # Utilitaires et services
│   └── api.ts               # Service API avec logging
├── types/                    # Types TypeScript
│   └── api.ts               # Types pour l'API
├── public/                   # Fichiers statiques
├── tailwind.config.js       # Configuration Tailwind
├── tsconfig.json            # Configuration TypeScript
└── package.json             # Dépendances
```

## 🔧 Configuration

### API Backend

L'application utilise l'API backend à l'adresse : `https://apiti.onrender.com`

Pour modifier l'URL de l'API, éditez le fichier `lib/api.ts` :

```typescript
const API_BASE_URL = 'https://apiti.onrender.com';
```

### Thème de couleurs

Le thème principal utilise des tons de vert. Pour personnaliser, modifiez `tailwind.config.js` :

```javascript
colors: {
  primary: {
    50: '#f0fdf4',
    // ... autres nuances
  },
}
```

## 📚 Utilisation

### Page d'accueil

- Affiche les statistiques globales
- Présente les fonctionnalités principales
- Liens vers la carte interactive

### Carte Interactive

1. **Filtres** - Sélectionnez une filière, catégorie ou produit
2. **Niveau de carte** - Choisissez entre régions, départements ou communes
3. **Recherche** - Recherchez des éléments spécifiques
4. **Interaction** - Cliquez sur une zone pour voir les détails
5. **Zoom** - La carte zoome automatiquement sur la sélection

### Logging

Toutes les requêtes API sont loggées dans la console du navigateur avec :
- 🔗 URL de la requête
- 📋 Méthode HTTP
- ✅ Réponse (en cas de succès)
- ❌ Erreur (en cas d'échec)

## 🎯 Routes API Principales

- `/api/v1/regions/` - Liste des régions
- `/api/v1/departements/` - Liste des départements
- `/api/v1/communes/` - Liste des communes
- `/api/v1/filieres/` - Liste des filières
- `/api/v1/produits/` - Liste des produits
- `/api/v1/productions/` - Données de production
- `/api/v1/geojson/regions` - GeoJSON des régions
- `/api/v1/statistiques/globales` - Statistiques globales

Voir la documentation Swagger complète : [https://apiti.onrender.com/docs](https://apiti.onrender.com/docs)

## 🌙 Mode Sombre

L'application détecte automatiquement les préférences du navigateur et s'adapte au mode clair/sombre. 
Un bouton de basculement est disponible dans l'en-tête.

## 🤝 Contribution

Les contributions sont les bienvenues ! N'hésitez pas à ouvrir une issue ou une pull request.

## 📄 Licence

Ce projet est développé dans le cadre du projet 5GI 2025-2026.

## 👥 Auteurs

Projet réalisé par un groupe d'étudiants pour la cartographie des bassins de production du Cameroun.

---

**Note** : Cette application utilise les données ouvertes des organismes publics camerounais et est destinée à des fins éducatives et de visualisation.


================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\tsconfig.json
================================================================================

{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts",
    "tailwind.config.js"
  ],
  "exclude": [
    "node_modules"
  ]
}



================================================================================
FICHIER: D:\5GI\Projet-TI\webmap\package.json
================================================================================

{
  "name": "cameroun-agro-map",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "leaflet": "^1.9.4",
    "lucide-react": "^0.263.1",
    "next": "^15.1.6",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-leaflet": "^4.2.1",
    "recharts": "^3.7.0"
  },
  "devDependencies": {
    "@types/leaflet": "^1.9.8",
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "autoprefixer": "^10.4.17",
    "eslint": "^9.39.2",
    "eslint-config-next": "^16.1.6",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  }
}


